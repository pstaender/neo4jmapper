!function(){"use strict";if("object"!=typeof window)throw Error("This file is for browser use, not for nodejs");if("undefined"==typeof window._)throw Error("Include of underscore.js library is needed");if("undefined"==typeof window.superagent)throw Error("Include of superagent library is needed");var Neo4jMapper=function(urlOrOptions){var _client_=null;if("object"==typeof window){var Neo4jRestful=this.Neo4jRestful=window.Neo4jMapper.initNeo4jRestful(urlOrOptions);this.client=_client_=new Neo4jRestful,this.Graph=window.Neo4jMapper.initGraph(_client_),this.Transaction=window.Neo4jMapper.initTransaction(_client_,this.Graph),this.Node=window.Neo4jMapper.initNode(_client_,this.Graph),this.Relationship=window.Neo4jMapper.initRelationship(_client_,this.Graph,this.Node),this.Path=window.Neo4jMapper.initPath(_client_,this.Graph),this.helpers=window.Neo4jMapper.helpers,this.helpers.ConditionalParameters=window.Neo4jMapper.ConditionalParameters,this.helpers.CypherQuery=window.Neo4jMapper.CypherQuery}else{var Neo4jRestful=this.Neo4jRestful=require("./neo4jrestful").init(urlOrOptions);this.client=_client_=new Neo4jRestful,this.Graph=require("./graph").init(_client_),this.Transaction=require("./transaction").init(_client_),this.Node=require("./node").init(_client_,this.Graph),this.Relationship=require("./relationship").init(_client_,this.Graph,this.Node),this.Path=require("./path").init(_client_,this.Graph),this.helpers=require("./helpers"),this.helpers.ConditionalParameters=require("./conditionalparameters"),this.helpers.CypherQuery=require("./cypherquery")}this.Node.Relationship=this.Relationship,this.Relationship.Node=this.Node,this.Neo4jRestful.Node=this.Node,this.Neo4jRestful.Path=this.Path,this.Neo4jRestful.Relationship=this.Relationship};Neo4jMapper.prototype.Node=null,Neo4jMapper.prototype.Relationship=null,Neo4jMapper.prototype.Graph=null,Neo4jMapper.prototype.Transaction=null,Neo4jMapper.prototype.Path=null,Neo4jMapper.prototype.Neo4jRestful=null,Neo4jMapper.prototype.client=null,Neo4jMapper.prototype.helpers=null,Neo4jMapper.init=function(urlOrOptions){return new Neo4jMapper(urlOrOptions)},"object"!=typeof window?module.exports=exports=Neo4jMapper:window.Neo4jMapper=Neo4jMapper,function(){function isSequence(obj){return obj instanceof Sequence}function Sequence(global_context){function next(){var args=Array.prototype.slice.call(arguments),seq=stack.shift();return data=arguments,seq?(args.unshift(next),seq.callback.apply(seq._context,args),void 0):(waiting=!0,void 0)}function then(callback,context){if("function"!=typeof callback)throw new Error("`Sequence().then(callback [context])` requires that `callback` be a function and that `context` be `null`, an object, or a function");return stack.push({callback:callback,_context:null===context?null:context||global_context,index:stack.length}),waiting&&(waiting=!1,next.apply(null,data)),self}var data,self=this,waiting=!0,stack=[];return isSequence(this)?(global_context=global_context||null,self.next=next,self.then=then,void 0):new Sequence(global_context)}function createSequence(context){return new Sequence(context)}Sequence.create=createSequence,Sequence.isSequence=isSequence,"object"==typeof window?window.Sequence=Sequence:module.exports=Sequence}();var md5=function(string){function RotateLeft(lValue,iShiftBits){return lValue<<iShiftBits|lValue>>>32-iShiftBits}function AddUnsigned(lX,lY){var lX4,lY4,lX8,lY8,lResult;return lX8=2147483648&lX,lY8=2147483648&lY,lX4=1073741824&lX,lY4=1073741824&lY,lResult=(1073741823&lX)+(1073741823&lY),lX4&lY4?2147483648^lResult^lX8^lY8:lX4|lY4?1073741824&lResult?3221225472^lResult^lX8^lY8:1073741824^lResult^lX8^lY8:lResult^lX8^lY8}function F(x,y,z){return x&y|~x&z}function G(x,y,z){return x&z|y&~z}function H(x,y,z){return x^y^z}function I(x,y,z){return y^(x|~z)}function FF(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(F(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)}function GG(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(G(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)}function HH(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(H(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)}function II(a,b,c,d,x,s,ac){return a=AddUnsigned(a,AddUnsigned(AddUnsigned(I(b,c,d),x),ac)),AddUnsigned(RotateLeft(a,s),b)}function ConvertToWordArray(string){for(var lWordCount,lMessageLength=string.length,lNumberOfWords_temp1=lMessageLength+8,lNumberOfWords_temp2=(lNumberOfWords_temp1-lNumberOfWords_temp1%64)/64,lNumberOfWords=16*(lNumberOfWords_temp2+1),lWordArray=Array(lNumberOfWords-1),lBytePosition=0,lByteCount=0;lMessageLength>lByteCount;)lWordCount=(lByteCount-lByteCount%4)/4,lBytePosition=8*(lByteCount%4),lWordArray[lWordCount]=lWordArray[lWordCount]|string.charCodeAt(lByteCount)<<lBytePosition,lByteCount++;return lWordCount=(lByteCount-lByteCount%4)/4,lBytePosition=8*(lByteCount%4),lWordArray[lWordCount]=lWordArray[lWordCount]|128<<lBytePosition,lWordArray[lNumberOfWords-2]=lMessageLength<<3,lWordArray[lNumberOfWords-1]=lMessageLength>>>29,lWordArray}function WordToHex(lValue){var lByte,lCount,WordToHexValue="",WordToHexValue_temp="";for(lCount=0;3>=lCount;lCount++)lByte=255&lValue>>>8*lCount,WordToHexValue_temp="0"+lByte.toString(16),WordToHexValue+=WordToHexValue_temp.substr(WordToHexValue_temp.length-2,2);return WordToHexValue}function Utf8Encode(string){string=string.replace(/\r\n/g,"\n");for(var utftext="",n=0;n<string.length;n++){var c=string.charCodeAt(n);128>c?utftext+=String.fromCharCode(c):c>127&&2048>c?(utftext+=String.fromCharCode(192|c>>6),utftext+=String.fromCharCode(128|63&c)):(utftext+=String.fromCharCode(224|c>>12),utftext+=String.fromCharCode(128|63&c>>6),utftext+=String.fromCharCode(128|63&c))}return utftext}var k,AA,BB,CC,DD,a,b,c,d,x=Array(),S11=7,S12=12,S13=17,S14=22,S21=5,S22=9,S23=14,S24=20,S31=4,S32=11,S33=16,S34=23,S41=6,S42=10,S43=15,S44=21;for(string=Utf8Encode(string),x=ConvertToWordArray(string),a=1732584193,b=4023233417,c=2562383102,d=271733878,k=0;k<x.length;k+=16)AA=a,BB=b,CC=c,DD=d,a=FF(a,b,c,d,x[k+0],S11,3614090360),d=FF(d,a,b,c,x[k+1],S12,3905402710),c=FF(c,d,a,b,x[k+2],S13,606105819),b=FF(b,c,d,a,x[k+3],S14,3250441966),a=FF(a,b,c,d,x[k+4],S11,4118548399),d=FF(d,a,b,c,x[k+5],S12,1200080426),c=FF(c,d,a,b,x[k+6],S13,2821735955),b=FF(b,c,d,a,x[k+7],S14,4249261313),a=FF(a,b,c,d,x[k+8],S11,1770035416),d=FF(d,a,b,c,x[k+9],S12,2336552879),c=FF(c,d,a,b,x[k+10],S13,4294925233),b=FF(b,c,d,a,x[k+11],S14,2304563134),a=FF(a,b,c,d,x[k+12],S11,1804603682),d=FF(d,a,b,c,x[k+13],S12,4254626195),c=FF(c,d,a,b,x[k+14],S13,2792965006),b=FF(b,c,d,a,x[k+15],S14,1236535329),a=GG(a,b,c,d,x[k+1],S21,4129170786),d=GG(d,a,b,c,x[k+6],S22,3225465664),c=GG(c,d,a,b,x[k+11],S23,643717713),b=GG(b,c,d,a,x[k+0],S24,3921069994),a=GG(a,b,c,d,x[k+5],S21,3593408605),d=GG(d,a,b,c,x[k+10],S22,38016083),c=GG(c,d,a,b,x[k+15],S23,3634488961),b=GG(b,c,d,a,x[k+4],S24,3889429448),a=GG(a,b,c,d,x[k+9],S21,568446438),d=GG(d,a,b,c,x[k+14],S22,3275163606),c=GG(c,d,a,b,x[k+3],S23,4107603335),b=GG(b,c,d,a,x[k+8],S24,1163531501),a=GG(a,b,c,d,x[k+13],S21,2850285829),d=GG(d,a,b,c,x[k+2],S22,4243563512),c=GG(c,d,a,b,x[k+7],S23,1735328473),b=GG(b,c,d,a,x[k+12],S24,2368359562),a=HH(a,b,c,d,x[k+5],S31,4294588738),d=HH(d,a,b,c,x[k+8],S32,2272392833),c=HH(c,d,a,b,x[k+11],S33,1839030562),b=HH(b,c,d,a,x[k+14],S34,4259657740),a=HH(a,b,c,d,x[k+1],S31,2763975236),d=HH(d,a,b,c,x[k+4],S32,1272893353),c=HH(c,d,a,b,x[k+7],S33,4139469664),b=HH(b,c,d,a,x[k+10],S34,3200236656),a=HH(a,b,c,d,x[k+13],S31,681279174),d=HH(d,a,b,c,x[k+0],S32,3936430074),c=HH(c,d,a,b,x[k+3],S33,3572445317),b=HH(b,c,d,a,x[k+6],S34,76029189),a=HH(a,b,c,d,x[k+9],S31,3654602809),d=HH(d,a,b,c,x[k+12],S32,3873151461),c=HH(c,d,a,b,x[k+15],S33,530742520),b=HH(b,c,d,a,x[k+2],S34,3299628645),a=II(a,b,c,d,x[k+0],S41,4096336452),d=II(d,a,b,c,x[k+7],S42,1126891415),c=II(c,d,a,b,x[k+14],S43,2878612391),b=II(b,c,d,a,x[k+5],S44,4237533241),a=II(a,b,c,d,x[k+12],S41,1700485571),d=II(d,a,b,c,x[k+3],S42,2399980690),c=II(c,d,a,b,x[k+10],S43,4293915773),b=II(b,c,d,a,x[k+1],S44,2240044497),a=II(a,b,c,d,x[k+8],S41,1873313359),d=II(d,a,b,c,x[k+15],S42,4264355552),c=II(c,d,a,b,x[k+6],S43,2734768916),b=II(b,c,d,a,x[k+13],S44,1309151649),a=II(a,b,c,d,x[k+4],S41,4149444226),d=II(d,a,b,c,x[k+11],S42,3174756917),c=II(c,d,a,b,x[k+2],S43,718787259),b=II(b,c,d,a,x[k+9],S44,3951481745),a=AddUnsigned(a,AA),b=AddUnsigned(b,BB),c=AddUnsigned(c,CC),d=AddUnsigned(d,DD);var temp=WordToHex(a)+WordToHex(b)+WordToHex(c)+WordToHex(d);return temp.toLowerCase()};if("object"==typeof window?window.Neo4jMapper.md5=md5:module.exports=exports=md5,"object"==typeof window)var _=window._;else var _=require("underscore");var isConditionalOperator=/^\$(AND|OR|XOR|NOT|AND\$NOT|OR\$NOT)$/i,sortStringAndOptionsArguments=function(string,options){return"object"==typeof string?{string:null,options:string}:{string:string||null,options:options||{}}},sortOptionsAndCallbackArguments=function(options,callback){return"function"==typeof options?{options:{},callback:options}:{options:options||{},callback:callback}},sortStringAndCallbackArguments=function(string,callback){return"function"==typeof string&&(callback=string,string=null),{callback:callback,string:string}},getIdFromObject=function(o){return"object"!=typeof o||isNaN(o._id_)?isNaN(parseInt(o))?o.id||null:parseInt(o):o._id_},flattenObject=function(ob,keepNullValues){var toReturn={};"boolean"!=typeof keepNullValues&&(keepNullValues=!0);for(var i in ob)if(ob.hasOwnProperty(i))if(keepNullValues&&null===ob[i])toReturn[i]=ob[i];else if("object"==typeof ob[i]){var flatObject=flattenObject(ob[i]);for(var x in flatObject)flatObject.hasOwnProperty(x)&&(toReturn[i+"."+x]=flatObject[x])}else toReturn[i]=ob[i];return toReturn},unflattenObject=function(target,opts){function getkey(key){var parsedKey=parseInt(key);return isNaN(parsedKey)?key:parsedKey}var opts=opts||{},delimiter=opts.delimiter||".",result={};return"[object Object]"!==Object.prototype.toString.call(target)?target:(Object.keys(target).forEach(function(key){var firstNibble,secondNibble,split=key.split(delimiter),recipient=result;for(firstNibble=getkey(split.shift()),secondNibble=getkey(split[0]);void 0!==secondNibble;)void 0===recipient[firstNibble]&&(recipient[firstNibble]="number"==typeof secondNibble?[]:{}),recipient=recipient[firstNibble],split.length>0&&(firstNibble=getkey(split.shift()),secondNibble=getkey(split[0]));recipient[firstNibble]=unflattenObject(target[key])}),result)},escapeString=function(s){return"string"!=typeof s?s:((/^".+"$/.test(s)||/^'.+'$/.test(s))&&(s=s.substr(1,s.length-2)),s.replace(/^(['"]{1})/,"\\$1").replace(/([^\\]){1}(['"]{1})/g,"$1\\$2"))},escapeProperty=function(identifier,delimiter){"string"!=typeof delimiter&&(delimiter="`");var appending=identifier.match(/^(.*)([\?\!]{1})$/)||"";return appending&&appending[2]&&(identifier=appending[1],appending=appending[2]),new RegExp(""+delimiter+"{1}$").test(identifier)?identifier:(identifier=identifier.replace(new RegExp(delimiter,"g"),""),identifier=/^(.+?)\..+$/.test(identifier)?identifier.replace(/^(.+?)\.(.+)$/,"$1."+delimiter+"$2"+delimiter):delimiter+identifier+delimiter,identifier+appending)},valueToStringForCypherQuery=function(value,delimiter){return"string"!=typeof delimiter&&(delimiter=""),value&&value.constructor===RegExp?(value=value.toString().replace(/^\/(\^)*(.+?)\/[ig]*$/,value.ignoreCase?"$1(?i)$2":"$1$2"),value=value.replace(/([^\\]{1})\\([^\\]{1})/g,"$1\\\\$2")):value="undefined"==typeof value||null===value?"NULL":0/0===value?delimiter+"NaN"+delimiter:"boolean"==typeof value||"number"==typeof value?String(value):delimiter+escapeString(value)+delimiter,value},cypherKeyValueToString=function(key,originalValue,identifier,conditionalParametersObject){var value=originalValue,s="";return"object"!=typeof conditionalParametersObject&&(conditionalParametersObject=null),"string"==typeof identifier&&(key=/^[nmr]\./.test(key)?key:/[\?\!]$/.test(key)?identifier+"."+key:identifier+"."+key),key=escapeProperty(key),_.isRegExp(value)?(value=valueToStringForCypherQuery(value),value=conditionalParametersObject&&conditionalParametersObject.valuesToParameters?conditionalParametersObject.addValue?conditionalParametersObject.addValue(value):value:"'"+value+"'",s=key+" =~ "+value):(value=_.isNumber(value)||_.isBoolean(value)?conditionalParametersObject&&conditionalParametersObject.valuesToParameters?conditionalParametersObject.addValue?conditionalParametersObject.addValue(value):value:valueToStringForCypherQuery(value):conditionalParametersObject&&conditionalParametersObject.valuesToParameters?conditionalParametersObject.addValue?conditionalParametersObject.addValue(value):value:"'"+escapeString(value)+"'",s=key+" = "+value),s},extractAttributesFromCondition=function(condition,attributes){return"undefined"==typeof attributes&&(attributes=[]),_.each(condition,function(value,key){_.isObject(value)&&extractAttributesFromCondition(condition[key],attributes),!isConditionalOperator.test(key)&&/^[a-zA-Z\_\-\.]+$/.test(key)&&attributes.push(key.replace(/^[nmr]{1}\./,""))}),_.uniq(attributes)},constructorNameOfFunction=function(func){var name=func.constructor.toString().match(/^function\s(.+?)\(/)[1];return"Function"===name&&(name=func.toString().match(/^function\s(.+)\(/)[1]),name},isObjectLiteral=function(data){return Boolean("object"==typeof data&&null!==data&&"number"==typeof Object.keys(data).length)},serializeObjectForCypher=function(o,options){o=this.flattenObject(o);var result=[];"object"!=typeof options&&(options={}),options=_.defaults(options,{identifierDelimiter:"`",valueDelimiter:"'"});for(var attr in o){var value=o[attr];result.push(escapeProperty(attr)+" : "+valueToStringForCypherQuery(value,options.valueDelimiter))}return"{ "+result.join(", ")+" }"},helpers={sortStringAndOptionsArguments:sortStringAndOptionsArguments,sortOptionsAndCallbackArguments:sortOptionsAndCallbackArguments,sortStringAndCallbackArguments:sortStringAndCallbackArguments,flattenObject:flattenObject,unflattenObject:unflattenObject,extractAttributesFromCondition:extractAttributesFromCondition,getIdFromObject:getIdFromObject,escapeString:escapeString,escapeProperty:escapeProperty,constructorNameOfFunction:constructorNameOfFunction,cypherKeyValueToString:cypherKeyValueToString,valueToStringForCypherQuery:valueToStringForCypherQuery,md5:"object"==typeof window?window.Neo4jMapper.md5:require("./lib/md5"),isConditionalOperator:isConditionalOperator,isObjectLiteral:isObjectLiteral,serializeObjectForCypher:serializeObjectForCypher};if("object"!=typeof window?module.exports=exports=helpers:window.Neo4jMapper.helpers=helpers,"object"==typeof window)var _=window._,helpers=window.Neo4jMapper.helpers;else var _=require("underscore"),helpers=require("./helpers");var ConditionalParameters=function ConditionalParameters(conditions,options){if(ConditionalParameters.parameterRuleset={$IN:function(value){var s="";if("object"==typeof value&&value.length>0){for(var i=0;i<value.length;i++)value[i]="string"==typeof value[i]?"'"+helpers.escapeString(value[i])+"'":helpers.valueToStringForCypherQuery(value[i]);s=value.join(", ")}return"IN [ "+s+" ]"},$in:function(value){return this.$IN(value)}},ConditionalParameters.prototype.addValue=function(value){this.parameters||(this.parameters={});var property="_value"+(this.parametersStartCountAt+this.parametersCount())+"_";return this.parameters[property]=value,"{"+property+"}"},ConditionalParameters.prototype.values=function(){var values=[];for(var prop in this.parameters)values.push(this.parameters[prop]);return values},ConditionalParameters.prototype.parametersCount=function(){return"object"!=typeof this.parameters||null===this.parameters?0:Object.keys(this.parameters).length},ConditionalParameters.prototype.hasParameters=function(){return this.parametersCount()>0},ConditionalParameters.prototype.cypherKeyValueToString=function(key,originalValue,identifier){return helpers.cypherKeyValueToString(key,originalValue,identifier,this)},ConditionalParameters.prototype.convert=function(condition,operator){"undefined"==typeof condition&&(condition=this.conditions);var options=_.extend({},this.defaultOptions,this.options);if(options.firstLevel&&(options.firstLevel=!1),options.parametersStartCountAt&&(this.parametersStartCountAt=options.parametersStartCountAt),"string"==typeof condition&&(condition=[condition]),"undefined"==typeof operator&&(operator=this.operator),"object"==typeof condition)for(var key in condition){var value=condition[key],property=null;if(_.isObject(condition[key])){var properties=[],firstKey=_.keys(value)?_.keys(value)[0]:null;if(firstKey&&ConditionalParameters.is_operator.test(firstKey))properties.push(this.convert(condition[key][firstKey],firstKey.replace(/\$/g," ").trim().toUpperCase(),options));else for(var k in condition[key]){var property=k.replace(/^[nmrp]\./,"");value=condition[key][k];var identifierWithProperty=/\?$/.test(property)?"":property;identifierWithProperty&&(identifierWithProperty=options.identifier?options.identifier+"."+identifierWithProperty:k,identifierWithProperty=helpers.escapeProperty(identifierWithProperty));var hasAttribute=identifierWithProperty?"HAS ("+identifierWithProperty+") AND ":"";value===k?properties.push(hasAttribute+value):"object"==typeof value&&null!==value&&1===Object.keys(value).length&&"function"==typeof ConditionalParameters.parameterRuleset[Object.keys(value)[0]]?properties.push(hasAttribute+" "+(identifierWithProperty||k)+" "+ConditionalParameters.parameterRuleset[Object.keys(value)[0]](value[Object.keys(value)[0]])):properties.push(hasAttribute+this.cypherKeyValueToString(k,value,/^[a-zA-Z\_\-]+\./.test(k)?null:options.identifier))}condition[key]=properties.join(" "+operator+" ")}}return 1===condition.length&&options.firstLevel===!1&&/NOT/i.test(operator)?operator+" ( "+condition.join("")+" )":"( "+condition.join(" "+operator+" ")+" )"},ConditionalParameters.prototype.toString=function(){return this.conditions&&(this._s=this.convert()),this._s},"object"!=typeof conditions){if("string"==typeof conditions)return this.conditions=null,this._s="( "+conditions+" )",void 0;throw Error("First argument must be an object with conditional parameters or a plain string")}this.conditions=conditions?conditions:{},"object"==typeof options&&(this.options=options,"undefined"!=typeof this.options.valuesToParameters&&(this.valuesToParameters=this.options.valuesToParameters),"undefined"!=typeof this.options.identifier&&(this.identifier=this.options.identifier),"undefined"!=typeof this.options.operator&&(this.operator=this.options.operator))};if(ConditionalParameters.is_operator=/^\$(AND|OR|XOR|NOT|AND\$NOT|OR\$NOT)$/i,ConditionalParameters.prototype.operator="AND",ConditionalParameters.prototype.identifier="n",ConditionalParameters.prototype.conditions=null,ConditionalParameters.prototype.options=null,ConditionalParameters.prototype.defaultOptions={firstLevel:!0,identifier:null},ConditionalParameters.prototype.parameters=null,ConditionalParameters.prototype.valuesToParameters=!0,ConditionalParameters.prototype._s="",ConditionalParameters.prototype.parametersStartCountAt=0,"object"==typeof window?window.Neo4jMapper.ConditionalParameters=ConditionalParameters:module.exports=exports=ConditionalParameters,"object"==typeof window)var _=window._,helpers=window.Neo4jMapper.helpers;else var _=require("underscore"),helpers=require("./helpers");var CypherQuery=function CypherQuery(query,parameters){this.statements=[],"string"==typeof query?this.query=query:"object"==typeof query&&(this.statements=query),parameters&&(this.parameters=parameters),this.cypher=_.extend(CypherQuery.prototype.cypher)};CypherQuery.prototype.statementsToString=function(options){var s="",chopLength=15,defaultOptions={niceFormat:!0};if(this.statements){"object"!=typeof options?options={}:_.defaults(options,defaultOptions);for(var i=0;i<this.statements.length;i++){var queryFragment=this.statements[i];if("string"!=typeof queryFragment){var attribute=Object.keys(this.statements[i])[0];if("object"!=typeof queryFragment||"function"!=typeof queryFragment.toQueryString){var forQuery=this.statements[i][attribute];attribute=attribute.replace(/([A-Z]{1})\_([A-Z]{1})/g,"$1 $2"),options.niceFormat&&(attribute+=Array(chopLength-attribute.length).join(" ")),null!==forQuery&&("string"==typeof forQuery?(forQuery=forQuery.trim().replace(new RegExp("^"+attribute+"\\s+","i"),""),forQuery=forQuery.replace(/\;$/,"")):forQuery=String(forQuery),s+="\n"+attribute+" "+forQuery+" ")}else queryFragment=queryFragment.toQueryString(),s+=queryFragment}else s+=queryFragment}s=s.trim().replace(/;+$/,"")}return s+";"},CypherQuery.prototype.query="",CypherQuery.prototype.parameters=null,CypherQuery.prototype.statements=null,CypherQuery.prototype.cypher={},CypherQuery.prototype.useParameters=!0,CypherQuery.prototype.hasParameters=function(){return this.parameters&&"object"==typeof this.parameters&&Object.keys(this.parameters).length>0},CypherQuery.prototype.toCypher=function(options){var s="";return this.query?s=this.query:this.statements.length>0&&(s=this.statementsToString(options)),s},CypherQuery.prototype.toString=function(options){var s=this.toCypher(options);if(s&&this.hasParameters())for(var key in this.parameters){var value=this.parameters[key];s=s.replace("{"+key+"}",helpers.valueToStringForCypherQuery(value,"'"))}return s},CypherQuery.prototype.addParameters=function(parameters){if("object"!=typeof parameters)throw Error('parameter(s) as argument must be an object, e.g. { key: "value" }');null===this.useParameters&&(this.useParameters=!0),(!this.hasParameters()||null!==parameters&&0===Object.keys(parameters).length)&&(this.parameters={});for(var attr in parameters)this.parameters[attr]=void 0===parameters[attr]?null:parameters[attr];return this},CypherQuery.prototype.addParameter=CypherQuery.prototype.addParameters,"object"==typeof window?window.Neo4jMapper.CypherQuery=CypherQuery:module.exports=exports=CypherQuery;var __initNeo4jRestful__=function(urlOrOptions){var helpers=null,_=null,jQuery=null,Sequence=null,JSONStream=null,request=null,__established_connection__={};"object"==typeof window?(helpers=window.Neo4jMapper.helpers,_=window._,jQuery=window.jQuery,Sequence=window.Sequence,request=window.superagent):(helpers=require("./helpers"),_=require("underscore"),jQuery=null,Sequence=require("./lib/sequence"),request=require("request"),JSONStream=require("JSONStream"));var ResponseError=function(message,code){var e=new Error(message);return e.code=code,e};ResponseError.prototype.code=0;var CustomError=function(message){"string"==typeof message&&(this.message=message)};CustomError.prototype.message="",CustomError.prototype.name="",CustomError.prototype.exception=null,CustomError.prototype.cypher=null,CustomError.prototype.stacktrace=null,CustomError.prototype.statusCode=null,CustomError.prototype.method=null,CustomError.prototype.url=null,CustomError.prototype.data=null;var RequestDebug=function(obj){if("object"==typeof obj&&obj)for(var key in obj)this[key]=obj[key]};RequestDebug.prototype.options=null,RequestDebug.prototype.requested_url="",RequestDebug.prototype.method="",RequestDebug.prototype.header=null,RequestDebug.prototype.res=null,RequestDebug.prototype.status=null,RequestDebug.prototype.err=null,RequestDebug.prototype.responseTime=null;var QueryError=function(message,options,name){var error=new CustomError(message);error.name="string"==typeof name?name:"QueryError","object"==typeof options&&(error=_.extend(error,options))},CypherQueryError=function(message,options){var error=QueryError(message,options,"CypherQueryError");return _.extend(this,error)},Neo4jRestful=function Neo4jRestful(url,options){var self=this,urlPattern=/^(http(s)*)\:\/\/((.+?)\:(.+?)\@)*(.+?)(\:([0-9]+)?)\/(.+)*$/i,urlMatches=null;if("undefined"==typeof url&&(url=urlOrOptions),"object"!=typeof options&&(options="object"==typeof url?url:{}),"string"==typeof url&&(options.url=url),"string"!=typeof options.url)throw Error("No url found. Argument must be either an URL as string or an option object including an `.url` property.");if(options.url=options.url.replace(/\/*$/,"/"),!urlPattern.test(options.url)){var message="Your URL ("+url+") needs to match the default url pattern 'http(s)://(username:password@)domain(:port)/(endpoint)…'";throw Error(message)}urlMatches=options.url.match(urlPattern),this.urlOptions=_.defaults({protocol:urlMatches[1],user:urlMatches[4],password:urlMatches[5],domain:urlMatches[6],port:urlMatches[8],endpoint:urlMatches[9]},this.urlOptions),this.urlOptions.endpoint&&(this.urlOptions.endpoint=this.urlOptions.endpoint.replace(/^\/+/,"")),"function"==typeof options.onConnectionError&&(this.onConnectionError=options.onConnectionError),self.header=_.extend({},Neo4jRestful.prototype.header),__established_connection__[this.absoluteUrl("/")]||self.checkAvailability()};return Neo4jRestful.RequestDebug=RequestDebug,Neo4jRestful.CustomError=CustomError,Neo4jRestful.prototype.options=null,Neo4jRestful.prototype.header={Accept:"application/json","Content-Type":"application/json"},Neo4jRestful.prototype.timeout=5e3,Neo4jRestful.prototype.exact_version=null,Neo4jRestful.prototype.version=null,Neo4jRestful.prototype.ignore_exception_pattern=/^(Node|Relationship)NotFoundException$/,Neo4jRestful.prototype.urlOptions={protocol:"http",domain:"localhost",port:7474,user:"",password:"",endpoint:"db/data/"},Neo4jRestful.prototype._request_on_=null,Neo4jRestful.prototype._response_on_=null,Neo4jRestful.prototype._response_=null,Neo4jRestful.prototype._columns_=null,Neo4jRestful.prototype._detectTypesOnColumns_=!1,Neo4jRestful.prototype._debug_=null,Neo4jRestful.prototype.query=function(cypher,options,cb){var args;if((args=helpers.sortOptionsAndCallbackArguments(options,cb))&&(options=args.options)&&(cb=args.callback),"string"!=typeof cypher)throw Error("cypher argument has to be a string");this.log("**info**","cypher:",cypher.trim().replace(/\s+/g," ")),this.post("/"+this.urlOptions.endpoint+"cypher",{data:{query:cypher,params:options.params||{}}},function(err,result,debug){return cb(err,result,debug)})},Neo4jRestful.prototype.statement=function(){throw Error("Not implemented, yet")},Neo4jRestful.prototype.checkAvailability=function(cb){var self=this;return this._sendHttpRequest({method:"GET",url:self.absoluteUrl("/"),timeout:self.timeout},function(err,res){var body=res?res.body:null;if("undefined"!=typeof res&&200===res.status&&body&&body.neo4j_version){self.exact_version=body.neo4j_version,self.version=Number(self.exact_version.replace(/^([0-9]+\.*[0-9]*)(.*)$/,"$1"));var error=self.version<2?Error("Neo4jMapper is not build+tested for neo4j version below v2"):null;__established_connection__[self.absoluteUrl("/")]=!0,"function"==typeof cb&&cb(error,body.neo4j_version)}else __established_connection__[self.absoluteUrl("/")]=!1,self.onConnectionError(Error("Can't detect neo4j… Sure neo4j service is available on "+self.absoluteUrl("/")+"? "+(err?"("+err.message+")":"")),self)}),this},Neo4jRestful.prototype.absoluteUrl=function(url){if("string"!=typeof url&&(url=""),url||(url=this.url||"/"),url){var baseUrl=this._connectionString();return baseUrl+url.replace(/^\/+/,"").replace(new RegExp("^"+this.urlOptions.endpoint.split("/").join("\\/")+"*"),"")}},Neo4jRestful.prototype._connectionString=function(){return this.urlOptions.protocol+"://"+String(this.urlOptions.user&&this.urlOptions.password?this.urlOptions.user+":"+this.urlOptions.password+"@":"")+this.urlOptions.domain+":"+this.urlOptions.port+"/"+this.urlOptions.endpoint},Neo4jRestful.prototype.request=function(url,options,cb){var debug=null;if("undefined"==typeof options&&(options={}),_.defaults(options,{method:"GET",data:null,debug:!1,header:_.extend({},this.header)}),"string"!=typeof url)throw Error("First argument 'url' hast to be a string");this.url=options.url=url,this.header=options.header;var requestedUrl=this.absoluteUrl(),data=options.data;"object"==typeof data&&null!==data&&(data=JSON.stringify(options.data)),this._debug_=new RequestDebug({options:options,requested_url:requestedUrl,method:options.method,data:data,header:this.header,res:null,status:null,err:null});var _options_={requestedUrl:requestedUrl,method:options.method,data:data,options:options,debug:debug,url:url};return this._makeRequest(_options_,cb)},Neo4jRestful.prototype._makeRequest=function(_options_,cb){var self=this;_.defaults(_options_,{cache:!1,timeout:this.timeout,loadNode:!0});var options=_options_.options;options.absolute_url=_options_.requestedUrl,options.url=_options_.url,options.method=_options_.method,options.data=_options_.data,this.log("**debug**","URI:",options.method+":"+options.url+" ("+options.absolute_url+")"),this.log("**debug**","sendedData:",options.data),this.log("**debug**","sendedHeader:",self.header),this._request_on_=(new Date).getTime();var requestOptions={method:options.method,url:options.absolute_url,header:self.header};if(options.data&&(requestOptions.data=options.data),"true"===this.header["X-Stream"]){var stream=JSONStream.parse([/^columns|data$/,!0]),isDataColumn=!1;self._columns_=[],stream.on("data",function(data){return isDataColumn?cb(data):data?data.constructor===Array?(isDataColumn=!0,cb(data)):(self._columns_.push(data),void 0):void 0}),stream.on("end",function(){cb(null,null)}),stream.on("root",function(root,count){self._response_on_=(new Date).getTime(),delete self.header["X-Stream"],count||cb(null,Error("No matches in stream found ("+root+")"),self._de)}),requestOptions.stream=stream}this._sendHttpRequest(requestOptions,function(err,res){self._response_=res,self._response_on_=(new Date).getTime(),self._debug_.responseTime=self.responseTime(),err?self.onError(cb,err,"error",options):res.status>=400?self.onError(cb,res.body,"error",options):(res.body&&(self._columns_=res.body.columns||null),self.onSuccess(cb,res.body,"success",options))})},Neo4jRestful.prototype._sendHttpRequest=function(options,cb){_.defaults(options,{header:{},data:null,method:"GET",timeout:null,stream:!1});var isBrowser=Boolean("object"==typeof window);if("function"!=typeof cb)throw Error("Callback as 2nd argument is mandatory");if("object"==typeof options&&options.url||cb(Error("Set { url: '…' } as argument")),isBrowser){var req=window.superagent(options.method,options.url).set(options.header);return options.data&&req.send(options.data),options.stream?req.pipe(options.stream):req.end(function(err,res){return"object"==typeof res&&(res.statusCode=res.status),cb(err,res)})}var req=request;return options.json=!0,options.data&&("string"==typeof options.data?options.body=options.data:options.json=options.data),options.stream?req(options).pipe(options.stream):req(options,function(err,res){return"object"==typeof res&&(res.status=res.statusCode),cb(err,res)})},Neo4jRestful.prototype.onProcess=function(res,cb,debug){if(!res)return cb(null,res,debug);if(_.isArray(res))for(var i=0;i<res.length;i++)res[i]=this.createObjectFromResponseData(res[i]);else if(res.data&&_.isArray(res.data))for(var row=0;row<res.data.length;row++)for(var column=0;column<res.data[row].length;column++)res.data[row][column]=this.createObjectFromResponseData(res.data[row][column]);else _.isObject(res)&&(res=this.createObjectFromResponseData(res));cb(null,res,debug)},Neo4jRestful.prototype.onProcessStream=function(res,cb,debug){if(res)for(var column=0;column<res.length;column++)res[column]=this.createObjectFromResponseData(res[column]);cb(null,res,debug)},Neo4jRestful.prototype.onSuccess=function(cb,res,status){return this._debug_.res=res,this._debug_.status=status,"success"===status?"function"==typeof this.onProcess?this.onProcess(res,cb,this._debug_):cb(null,res,this._debug_):(cb(res,status,this._debug_),void 0)},Neo4jRestful.prototype.onError=function(cb,responseError,res,options){if(responseError&&"object"==typeof responseError&&0===Object.keys(responseError).length)return cb(null,res.body||null,this._debug_);var err=responseError,self=this,statusCode=this._response_?this._response_.status:null,error=err&&err.responseText?Error(err.responseText):err;
if(!error){var errDescription="Response Error ("+this._response_.status+")";error=new ResponseError(errDescription,this._response_.status)}this._debug_.res=res,this._debug_.err=err,this._debug_.error=error;try{jQuery?jQuery(err.responseText).find("body pre:first, body p:first")[0]?err.responseText=jQuery(err.responseText).find("body pre:first, body p:first").first().text().trim().replace(/(\s|\n)+/g," "):jQuery(err.responseText).text()&&(err.responseText=jQuery(err.responseText).text().trim()):err.responseText=err.responseText.replace(/(<([^>]+)>)/gi,"").trim()}catch(e){}if(err&&err.responseText&&"string"==typeof err.responseText)try{var err=JSON.parse(err.responseText),ErrorHandler=/^(\/)*db\/data(\/)*$/.test(options.url)?CypherQueryError:QueryError;err=new ErrorHandler(err.message,{stacktrace:err.stacktrace,exception:err.exception,statusCode:statusCode,url:options.url,method:options.method,data:data})}catch(e){self.log("**debug** Could not create/parse a valuable error object",e)}return err&&err.exception&&self.ignore_exception_pattern&&self.ignore_exception_pattern.test(err.exception)?cb(null,null,this._debug_):cb(err||error,null,this._debug_)},Neo4jRestful.prototype.stream=function(cypher,options,cb){var args;(args=helpers.sortOptionsAndCallbackArguments(options,cb))&&(options=args.options)&&(cb=args.callback),this.header["X-Stream"]="true";var self=this,todo=0,done=0;if("string"!=typeof cypher)throw Error("cypher argument has to be a string");return this.query(cypher,options,function(data){return data?"function"!=typeof self.onProcessStream?cb(data,self,self._debug_):(todo++,self.onProcessStream(data,function(err,data){return data&&1===data.length&&(data=data[0]),done>=todo?(cb(data,self),cb(null,self,self._debug_)):cb(data,self,self._debug_)}),void 0):cb(null,self,self._debug_)})},Neo4jRestful.prototype.get=function(url,options,cb){var args;return(args=helpers.sortOptionsAndCallbackArguments(options,cb))&&(options=args.options)&&(cb=args.callback)&&(options.method="GET"),this.request(url,options,cb)},Neo4jRestful.prototype.post=function(url,options,cb){var args;return(args=helpers.sortOptionsAndCallbackArguments(options,cb))&&(options=args.options)&&(cb=args.callback)&&(options.method="POST"),this.request(url,options,cb)},Neo4jRestful.prototype.put=function(url,options,cb){var args;return(args=helpers.sortOptionsAndCallbackArguments(options,cb))&&(options=args.options)&&(cb=args.callback)&&(options.method="PUT"),this.request(url,options,cb)},Neo4jRestful.prototype.delete=function(url,options,cb){var args;return(args=helpers.sortOptionsAndCallbackArguments(options,cb))&&(options=args.options)&&(cb=args.callback)&&(options.method="DELETE"),this.request(url,options,cb)},Neo4jRestful.prototype.log=function(){},Neo4jRestful.prototype.createObjectFromResponseData=function(responseData,Class){if(null===responseData||""===responseData)return null;var uri=responseData?responseData.self:null,Node=Neo4jRestful.Node,Relationship=Neo4jRestful.Relationship,Path=Neo4jRestful.Path;if("function"!=typeof Class&&(Class=Node),uri){if(/\/db\/data\/node\/[0-9]+\/*$/.test(uri)){var n=new Class;return n=n.populateWithDataFromResponse(responseData)}if(/\/db\/data\/relationship\/[0-9]+\/*$/.test(uri)){var r=new Relationship;return r=r.populateWithDataFromResponse(responseData)}}else if(_.isNumber(responseData.length)&&_.isString(responseData.start)){var p=new Path;return p=p.populateWithDataFromResponse(responseData)}return responseData},Neo4jRestful.prototype.responseTime=function(){return this._request_on_>0&&this._response_on_>0?this._response_on_-this._request_on_:null},Neo4jRestful.prototype.responseTimeAsString=function(){var time=this.responseTime();return time?Math.floor(time/10)/100+"[s]":""},Neo4jRestful.prototype.onConnectionError=function(){},Neo4jRestful.prototype.singleton=function(){return new Neo4jRestful(this._connectionString())},Neo4jRestful.create=function(url,options){return new Neo4jRestful(url,options)},"object"==typeof window&&(window.Neo4jRestful=Neo4jRestful),Neo4jRestful};"object"!=typeof window?module.exports=exports={init:__initNeo4jRestful__}:window.Neo4jMapper.initNeo4jRestful=__initNeo4jRestful__;var __initNode__=function(neo4jrestful,Graph){if("object"==typeof window)var helpers=window.Neo4jMapper.helpers,_=window._,ConditionalParameters=window.Neo4jMapper.ConditionalParameters,CypherQuery=window.Neo4jMapper.CypherQuery;else var helpers=require("./helpers"),_=require("underscore"),ConditionalParameters=require("./conditionalparameters"),CypherQuery=require("./cypherquery");var Node=function(data,id,cb){return"function"==typeof id&&(cb=id,id=void 0),this._constructor_name_||(this._constructor_name_=helpers.constructorNameOfFunction(this)||"Node"),this.init(data,id),cb?this.save(cb):void 0};return Node.prototype.init=function(data,id){return this.setId(id||null),this.data=_.extend({},data),this.resetQuery(),id&&this.setUriById(id),this.fields=_.extend({},{defaults:_.extend({},this.fields.defaults),indexes:_.extend({},this.fields.indexes),unique:_.extend({},this.fields.unique)}),this.labels=_.uniq(this.labels),this._is_instanced_=!0,this},Node.prototype.convertToModel=function(model){var Class=this.recommendConstructor();"function"==typeof model?Class=model:"string"==typeof model&&Node.registeredModel(model)&&(Class=Node.registeredModel(model));var node=new Class;return this.copyTo(node),node},Node.instantiateNodeAsModel=function(node,labels,label){var model=label;return"string"==typeof labels&&(model=labels),labels&&1===labels.length&&(model=labels[0]),model&&(node=node.convertToModel(model)),node.setLabels(labels),node.isPersisted(!0),node},Node.__models__={},Node.prototype.classification="Node",Node.prototype.data={},Node.prototype.id=null,Node.prototype._id_=null,Node.prototype.fields={defaults:{},indexes:{},unique:{}},Node.prototype.uri=null,Node.prototype._response_=null,Node.prototype._query_history_=null,Node.prototype._stream_=null,Node.prototype._hashedData_=null,Node.prototype.Relationship=null,Node.cypherStatementSegments={limit:"",skip:"",filter:"",match:null,start:null,set:"",With:null,distinct:null,return_properties:[],where:[],hasProperty:[],from:null,to:null,direction:null,order_by:"",order_direction:"",relationship:"",outgoing:null,incoming:null,label:null,node_identifier:null,parameters:null,count:"",_optionalMatch:null,_count:null,_distinct:null,by_id:null},Node.prototype._is_instanced_=null,Node.prototype._is_singleton_=!1,Node.prototype._is_loaded_=null,Node.prototype.labels=null,Node.prototype.label=null,Node.prototype._constructor_name_=null,Node.prototype._load_hook_reference_=null,Node.prototype.__skip_loading_labels__=null,Node.prototype.__TYPE__="node",Node.prototype.__TYPE_IDENTIFIER__="n",Node.prototype.initialize=function(cb){var self=this;return this.onBeforeInitialize(function(err,res,debug){err?cb(err,null,debug):self.onAfterInitialize(cb)})},Node.prototype.onBeforeInitialize=function(next){return next(null,null,null)},Node.prototype.onAfterInitialize=function(cb){var self=this,fieldsToIndex=this.fieldsForAutoindex(),node=new this.constructor,label=node.label;return label?fieldsToIndex.length>0?node.ensureIndex({label:label,fields:fieldsToIndex},function(err,res,debug){return cb(err,self.constructor,debug)}):cb(null,self.constructor,null):cb(Error("No label found"),this.constructor,null)},Node.prototype.copyTo=function(n){return n.id=n._id_=this._id_,n.data=_.extend(this.data),n.labels=_.clone(this.labels),this.label&&(n.label=this.label),n.uri=this.uri,n._response_=_.extend(this._response_),null},Node.prototype.resetQuery=function(){return this.cypher=new CypherQuery,this.cypher.segments={},_.extend(this.cypher.segments,this.constructor.cypherStatementSegments),this.cypher.segments.where=[],this.cypher.segments.hasProperty=[],this.cypher.segments.match=[],this.cypher.segments.return_properties=[],this.cypher.segments.start={},this._query_history_=[],this.id&&(this.cypher.segments.from=this.id),this},Node.prototype.hasId=function(){return this._is_instanced_&&_.isNumber(this._id_)?!0:!1},Node.prototype.setUriById=function(id){return _.isNumber(id)&&(this.uri=Graph.request().absoluteUrl(this.__TYPE__+"/"+id)),this},Node.prototype.flattenData=function(useReference){if("boolean"!=typeof useReference&&(useReference=!1),"object"==typeof this.data&&null!==this.data){var data=useReference?this.data:_.extend(this.data);return data=helpers.flattenObject(data)}return this.data},Node.prototype.dataForCypher=function(){var data=this.flattenData();for(var attr in data)data["`"+attr+"`"]=data[attr],delete data[attr];return data},Node.prototype.unflattenData=function(useReference){"boolean"!=typeof useReference&&(useReference=!1);var data=useReference?this.data:_.extend(this.data);return helpers.unflattenObject(data)},Node.prototype.hasValidData=function(){return helpers.isObjectLiteral(this.data)},Node.prototype.applyDefaultValues=function(){var data=helpers.flattenObject(this.data),defaults=helpers.flattenObject(this.fields.defaults);for(var key in defaults)"undefined"!=typeof data[key]&&null!==data[key]||"undefined"==typeof defaults[key]||(data[key]="function"==typeof defaults[key]?defaults[key](this):defaults[key]);return this.data=helpers.unflattenObject(data),this},Node.prototype.hasFieldsToIndex=function(){return this.hasId()?_.keys(this.fields.indexes).length:null},Node.prototype.fieldsToIndex=function(){return this.fields.indexes&&_.keys(this.fields.indexes).length>0?helpers.flattenObject(this.fields.indexes):null},Node.prototype.fieldsToIndexUnique=function(){return this.fields.unique&&_.keys(this.fields.unique).length>0?helpers.flattenObject(this.fields.unique):null},Node.prototype.fieldsForAutoindex=function(){var fields=this.fieldsToIndex(),keys=[];return _.each(fields,function(toBeIndexed,field){toBeIndexed===!0&&keys.push(field)}),keys=_.uniq(_.union(keys,this.uniqueFields()))},Node.prototype.uniqueFields=function(){var keys=[];return _.each(this.fields.unique,function(isUnique,field){isUnique===!0&&keys.push(field)}),keys},Node.prototype.ensureIndex=function(options,cb){var args;(args=helpers.sortOptionsAndCallbackArguments(options,cb))&&(options=args.options)&&(cb=args.callback),options=_.extend({label:this.label,fields:this.fieldsForAutoindex(),unique:this.uniqueFields()||[]},options);var self=this,keys=_.uniq(_.union(options.fields,options.unique)),todo=keys.length,done=0,errors=[],results=[];if(!options.label)throw Error("Label is mandatory, you can set the label as options as well");var url="schema/index/"+options.label,queryHead="CREATE CONSTRAINT ON (n:"+options.label+") ASSERT ";return this.getIndex(function(err,indexedFields,debug){for(var i=0;i<indexedFields.length;i++)keys=_.without(keys,indexedFields[i]);return 0===keys.length?cb(null,null,debug):(_.each(keys,function(key){var isUnique=_.indexOf(options.unique,key)>=0,query=queryHead+"n.`"+key+"`"+(isUnique?" IS UNIQUE":"")+";",after=function(err,res){if(done++,"object"===err&&null!==err){var errAsArray=err.length>0?err:[err];errAsArray.forEach(function(err){err.cause&&err.cause.cause&&"AlreadyIndexedException"===err.cause.cause.exception?results.push(res):errors.push(err)})}else results.push(res);done===todo&&cb(errors.length>0?errors:null,results,debug)};isUnique?self.query(query,after):Graph.request().post(url,{data:{property_keys:[key]}},after)}),void 0)}),this},Node.prototype.dropIndex=function(fields,cb){if("function"==typeof fields&&(cb=fields,fields=this.fieldsForAutoindex()),!this.label)return cb(Error("You need to set a label on `node.label` to work with autoindex"),null);var todo=fields.length,done=0,url="schema/index/"+this.label;return 0===todo?cb(null,null):0===todo?cb(Error("No fields for indexing found",null)):(_.each(fields,function(field){Graph.request().delete(url+"/"+field,function(){done++,done===todo&&cb(null,null)})}),this)},Node.prototype.dropEntireIndex=function(cb){var self=this;return this.getIndex(function(err,fields){return err?cb(err,fields):self.dropIndex(fields,cb)}),this},Node.prototype.getIndex=function(cb){var label=this.label;if(!label)return cb(Error("You need to set a label on `node.label` to work with autoindex"),null);var url="schema/index/"+this.label;return Graph.request().get(url,function(err,res,debug){if("object"==typeof res&&null!==res){var keys=[];return _.each(res,function(data){data.label===label&&keys.push(data.property_keys)}),cb(null,_.flatten(keys),debug)}return cb(err,res,debug)})},Node.prototype._hashData_=function(){return this.hasValidData()?helpers.md5(JSON.stringify(this.toObject())):null},Node.prototype.isPersisted=function(setToTrueOrFalse){return"undefined"!=typeof setToTrueOrFalse&&(this._hashedData_=setToTrueOrFalse?this._hashData_():null),this._hashedData_?this._hashData_()===this._hashedData_:!1},Node.prototype.save=function(cb){var self=this,labels=self.labels.length>0?self.labels:null;return self._onBeforeSave(self,function(err){"undefined"!=typeof err&&null!==err?cb(err,null):self.onSave(function(err,node,debug){labels&&(self.labels=labels),self._onAfterSave(err,self,cb,debug)})})},Node.prototype._onBeforeSave=function(node,next){this.onBeforeSave(node,function(err){next(err)})},Node.prototype.onBeforeSave=function(node,next){next(null,null)},Node.prototype.onSave=function(cb){var self=this;if(this._is_singleton_)return cb(Error("Singleton instances can not be persisted"),null);if(!this.hasValidData())return cb(Error(this.__TYPE__+" does not contain valid data. `"+this.__TYPE__+".data` must be an object."));if(this.resetQuery(),this.applyDefaultValues(),this.id=this._id_,this.id>0)Graph.start("n = node({id})").addParameter({id:Number(this.id)}).setWith({n:this.dataForCypher()}).exec(function(err,res,debug){return err?cb(err,res,debug):(self.isPersisted(!0),cb(err,self,debug),void 0)});else{var labels=this.labels.length>0?":"+this.labels.join(":"):"",data={};data["n"+labels]=this.dataForCypher(),Graph.start().create(data).return("n").limit(1).exec(function(err,res,debug){if(err||!res)return cb(err,res,debug);var node=res;return node.copyTo(self),node=self,node._is_singleton_=!1,node._is_instanced_=!0,self.isPersisted(!0),cb(null,node,debug)})}},Node.prototype._onAfterSave=function(err,node,next,debug){this.onAfterSave(err,node,function(err,node,debug){var labels=node.labels=node.labelsAsArray();return err?next(err,node,debug):labels.length>0?(node.addLabels(labels,function(labelError,notUseableData,debugLabel){return labelError&&(err=labelError),debug&&(debug=debugLabel?[debug,debugLabel]:debug),next(err,node,debug)}),void 0):next(err,node,debug)},debug)},Node.prototype.onAfterSave=function(err,node,next,debug){return next(err,node,debug)},Node.prototype.update=function(data,cb){if(helpers.isObjectLiteral(data)){if(this.hasId()){if("function"!=typeof cb)throw Error("To perform an .update() on an instanced node, you have to give a cb as argument");return this.findById(this._id_).update(data,cb),this}data=helpers.flattenObject(data),this.cypher.segments.set=[];for(var attribute in data)this.addSetDefinition(attribute,data[attribute])}else cb(Error("To perform an update you need to pass valid data for updating as first argument"),null);return this.cypher.segments._update_=!0,this.cypher.segments.start[this.__TYPE_IDENTIFIER__]=this.__TYPE__+"("+this.cypher.segments.by_id+")",this.exec(cb)},Node.prototype.addSetDefinition=function(attribute,value){if(this.cypher.useParameters){this.cypher.hasParameters()||(this.cypher.parameters={});var parametersStartCountAt=this.cypher.parameters?Object.keys(this.cypher.parameters).length:0,key="_value"+parametersStartCountAt+"_",parameter={};parameter[key]=value,this.cypher.segments.set.push(helpers.cypherKeyValueToString(attribute,"{"+key+"}",this.__TYPE_IDENTIFIER__,{valuesToParameters:!0})),this._addParameterToCypher(value)}else this.cypher.segments.set.push(helpers.cypherKeyValueToString(attribute,value,this.__TYPE_IDENTIFIER__))},Node.prototype.load=function(cb,debug){var self=this;return this._onBeforeLoad(self,function(err,node){err?cb(err,node,debug):self._onAfterLoad(node,cb,debug)})},Node.prototype._onBeforeLoad=function(node,next,debug){this.onBeforeLoad(node,function(node){if(node.hasId()){var _createNodeFromLabel=function(node,debug){node.isPersisted(!0),node.__skip_loading_labels__=null,next(null,node,debug)};return node.__skip_loading_labels__?_createNodeFromLabel(node,debug):node.allLabels(function(err,labels,debug){return err?next(err,labels):(node.setLabels(labels),_createNodeFromLabel(node,debug))})}return next(null,node)})},Node.prototype.reload=function(cb){this._is_loaded_=!1,this.load(cb)},Node.prototype.onBeforeLoad=function(node,next){return next(node)},Node.prototype._onAfterLoad=function(node,next){node._is_loaded_=!0,this.onAfterLoad(node,function(err,node){next(err,node)})},Node.prototype.onAfterLoad=function(node,next){next(null,node)},Node.prototype.disableLoading=function(){return"function"==typeof this.load&&(this._load_hook_reference_=this.load,this.load=null),this},Node.prototype.enableLoading=function(){return"function"==typeof this._load_hook_reference_&&(this.load=this._load_hook_reference_,this._load_hook_reference_=null),this},Node.prototype.populateWithDataFromResponse=function(data){var node;return node=this._is_instanced_?this:new Node,node.resetQuery(),data&&(node._response_=_.isObject(data)&&!_.isArray(data)?data:data[0],node.data=node._response_.data,node.data=node.unflattenData(),node.uri=node._response_.self,node._response_.self&&node._response_.self.match(/[0-9]+$/)&&(node.id=node._id_=Number(node._response_.self.match(/[0-9]+$/)[0]))),node.isPersisted(!0),"function"==typeof node.onAfterPopulate&&node.onAfterPopulate(),node},Node.prototype.onAfterPopulate=function(){return this},Node.prototype.withLabel=function(label,cb){var self=this;return self.hasId()||"string"!=typeof label?self:(self._query_history_.push({withLabel:label}),self.cypher.segments.label=label,self.exec(cb))},Node.prototype.shortestPathTo=function(end,type,cb){return"function"==typeof type&&(cb=type,type=""),this.pathBetween(this,end,{type:type,algorithm:"shortestPath"},function(err,result,debug){return!err&&result?cb(err,result[0],debug):cb(err,result,debug)})},Node.prototype.pathBetween=function(start,end,options,cb){var defaultOptions={max_depth:0,relationships:{type:"",direction:"out"},algorithm:"shortestPath"};if("object"==typeof options?options=_.extend(defaultOptions,options):(cb=options,options=_.extend(defaultOptions)),options.max&&(options.max_depth=options.max),options.type&&(options.relationships.type=options.type),options.direction&&(options.relationships.direction=options.direction),start=helpers.getIdFromObject(start),end=helpers.getIdFromObject(end),start&&end){var type=options.relationships.type?":"+options.relationships.type:options.relationships.type;this.cypher.segments.start.a="node("+start+")",this.cypher.segments.start.b="node("+end+")";var matchString="p = "+options.algorithm+"((a)-["+type+(options.max_depth>0?".."+options.max_depth:"*")+"]-(b))";this.cypher.segments.match=[matchString.replace(/\[\:\*+/,"[*")],this.cypher.segments.return_properties=["p"]}return this.exec(cb)},Node.prototype.count=function(identifier,cb){return this.cypher.segments._count=!0,"function"==typeof identifier?(cb=identifier,identifier="*"):"string"!=typeof identifier&&(identifier="*"),Object.keys(this.cypher.segments.start).length<1&&(this.cypher.segments.start[this.__TYPE_IDENTIFIER__]=this.__TYPE__+"(*)"),this.cypher.segments.count="COUNT("+(this.cypher.segments._distinct?"DISTINCT ":"")+identifier+")",this.cypher.segments._distinct&&this.distinct(void 0,!1),"function"==typeof cb&&this.exec(function(err,result,debug){result&&result.data&&1===result.data.length&&(result=result.data[0][0]),cb(err,result,debug)}),this._query_history_.push({count:{distinct:this.cypher.segments._distinct,identifier:identifier}}),this},Node.prototype._prepareQuery=function(){var query=_.extend(this.cypher.segments),label=query.label?":"+query.label:"";this.cypher.segments.start&&this.cypher.segments&&Object.keys(this.cypher.segments.start).length<1&&(_.isNumber(query.from)&&(query.start={},query.start.n="node("+query.from+")",query.return_properties.push("n")),_.isNumber(query.to)&&(query.start.m="node("+query.to+")",query.return_properties.push("m")));var relationships="";if(query.return_properties&&query.return_properties.constructor===Array){var returnLabels=null;query.return_properties.forEach(function(returnProperty){null===returnLabels&&/^n(\s+.*)*$/.test(returnProperty)&&(returnLabels=!0)}),returnLabels&&!query.action&&query.return_properties.push("labels(n)"),query.return_properties=_.uniq(query.return_properties).join(", ")}if(query.relationship&&(relationships=query.relationship.constructor===Array?":"+helpers.escapeString(query.relationship.join("|")):":"+helpers.escapeString(query.relationship)),query.actionWith=query.count?query.count:query.return_properties,query.incoming||query.outgoing){var x="",y="";query.incoming&&query.outgoing?x=y="-":(query.incoming&&(x="<-",y="-"),query.outgoing&&(x="-",y="->")),0===query.match.length&&query.match.push("(n"+label+")"+x+"[r"+relationships+"]"+y+"("+(this.cypher.segments.to>0?"m":this.cypher.segments.to?this.cypher.segments.to.replace(/^\:*(.*)$/,":$1"):"")+")")}var __startObjectToString=function(start){var s=[];for(var attribute in start)s.push(attribute+" = "+start[attribute]);return s.join(", ").trim()};if((!query.return_properties||query.return_properties&&0==query.return_properties.length&&this.cypher.segments.start&&Object.keys(this.cypher.segments.start).length>0)&&(query.start_as_string=" "+__startObjectToString(query.start),/ [a-zA-Z]+ \= /.test(query.start_as_string))){var matches=query.start_as_string;query.return_properties=[],matches=matches.match(/[\s\,]([a-z]+) \= /g);for(var i=0;i<matches.length;i++)query.return_properties.push(matches[i].replace(/^[\s\,]*([a-z]+).*$/i,"$1"));query.return_properties=query.return_properties.join(", ")}if(query.match.length>0||!this.label||("n"===this.__TYPE_IDENTIFIER__?query.match=["(n:"+this.label+")"]:"r"===this.__TYPE_IDENTIFIER__&&(query.match=["[r:"+this.label+"]"])),this.cypher.segments.start&&Object.keys(this.cypher.segments.start).length<1&&!(query.match.length>0)&&(query.match.length>0?query.start="":query.start[this.__TYPE_IDENTIFIER__]=this.__TYPE__+"(*)"),_.isNumber(query.by_id)&&Object.keys(this.cypher.segments.start).length<=1){var id=query.by_id;this.cypher.useParameters?(this.cypher.segments.start.n="node({_node_id_})",this.cypher.addParameter({_node_id_:id})):this.cypher.segments.start.n="node("+id+")"}return query.hasProperty.length>0&&(_.uniq(query.hasProperty).forEach(function(property){query.where.unshift("HAS ("+property+")")}),query.where=_.unique(query.where)),query.start_as_string=__startObjectToString(query.start),query},Node.prototype.toQuery=function(){if(this.hasId()&&!(Object.keys(this.cypher.segments.start).length>1))return Node.findById(this._id_).toQuery();var query=this._prepareQuery(),graph=Graph.start(query.start_as_string);return query.match.length>0&&(this.cypher._optionalMatch?graph.optionalMatch(query.match.join(" AND ")):graph.match(query.match.join(" AND "))),query.where&&query.where.length>0&&graph.where(query.where.join(" AND ")),query.set&&graph.set(query.set),query.action?graph.custom(query.action+" "+query.actionWith):query._distinct?graph.returnDistinct(query.actionWith):graph.return(query.actionWith),query.order_by&&graph.orderBy(query.order_by+" "+query.order_direction),query.skip&&graph.skip(Number(query.skip)),query.limit&&graph.limit(Number(query.limit)),graph.cypher.parameters=this.cypher.parameters,graph.toQuery()},Node.prototype.toQueryString=function(){return this.toQuery().toString()},Node.prototype.toCypherQuery=function(){return this.toQuery().toCypher()},Node.prototype._start_node_id=function(fallback){return"undefined"==typeof fallback&&(fallback="*"),this.cypher.segments.from>0?this.cypher.segments.from:this.cypher.segments.by_id?this.cypher.segments.by_id:this.hasId()?this.id:fallback},Node.prototype._end_node_id=function(fallback){return"undefined"==typeof fallback&&(fallback="*"),this.cypher.segments.to>0?this.cypher.segments.to:fallback},Node.prototype.singletonForQuery=function(cypher){var singleton=this.singleton();return singleton.cypher=_.extend(singleton.cypher,cypher),this.hasId()?singleton.findById(this.id):this},Node.prototype.exec=function(cb,cypher_or_request){var request=null,cypherQuery=null;return"string"==typeof cypher_or_request?cypherQuery=cypher_or_request:"object"==typeof cypher_or_request&&(request=_.extend({type:"get",data:{},url:null},cypher_or_request)),"function"==typeof cb?(this.cypher.parameters=this.toQuery().parameters,this.query(this.toCypherQuery(),cb)):this},Node.prototype.query=function(cypherQuery,parameters,cb,options){var self=this;"function"==typeof parameters&&(cb=parameters,parameters={},options={}),options||(options={}),options.cypher=_.extend(this.cypher.segments,{parameters:this.cypher.parameters});var graph=Graph.start();if(this.load||graph.disableLoading(),this.label&&(options.label=this.label),options.recommendConstructor=this.recommendConstructor(),this.cypher.useParameters&&this.cypher.hasParameters()&&Object.keys(this.cypher.parameters).length>0&&graph.setParameters(this.cypher.parameters),"string"==typeof cypherQuery)return this._stream_?graph.stream(cypherQuery,parameters,cb,options):graph.query(cypherQuery,parameters,cb,options);if("object"==typeof cypherQuery){var request=cypherQuery;return request.type&&request.data&&request.url?Graph.request()[request.type](request.url,request.data,function(err,data,debug){data={data:[[data]]},graph._processResult(err,data,debug,self,cb)}):cb(Error("The 1st argument as request object must have the properties .url, .data and .type"),null)}return cb(Error("First argument must be a string with the cypher query"),null)},Node.prototype.withRelations=function(relation,cb){var self=this.singletonForQuery();return self._query_history_.push({withRelation:!0}),self.cypher.segments.relationship="string"==typeof relation?relation:relation.join("|"),self.cypher.segments.incoming=!0,self.cypher.segments.outgoing=!0,self.exec(cb),self},Node.prototype.incomingRelations=function(relation,cb){var self=this.singletonForQuery();return self._query_history_.push({incomingRelationships:!0}),"function"!=typeof relation?self.cypher.segments.relationship=relation:cb=relation,self.cypher.segments.node_identifier="n",self.cypher.segments.start.n="node("+self._start_node_id("*")+")",self.cypher.segments.to>0&&(self.cypher.segments.start.m="node("+self._end_node_id("*")+")"),self.cypher.segments.incoming=!0,self.cypher.segments.outgoing=!1,self.cypher.segments.return_properties=["r"],self.exec(cb),self},Node.prototype.outgoingRelations=function(relation,cb){var self=this.singletonForQuery();return self._query_history_.push({outgoingRelationships:!0}),"function"!=typeof relation?self.cypher.segments.relationship=relation:cb=relation,self.cypher.segments.node_identifier="n",self.cypher.segments.start.n="node("+self._start_node_id("*")+")",self.cypher.segments.to>0&&(self.cypher.segments.start.m="node("+self._end_node_id("*")+")"),self.cypher.segments.incoming=!1,self.cypher.segments.outgoing=!0,self.cypher.segments.return_properties=["r"],self.exec(cb),self},Node.prototype.incomingRelationsFrom=function(node,relation,cb){var self=this.singletonForQuery();return self._query_history_.push({incomingRelationshipsFrom:!0}),self.cypher.segments.from=self.id||null,self.cypher.segments.to=helpers.getIdFromObject(node)||node,"function"!=typeof relation&&(self.cypher.segments.relationship=relation),self.cypher.segments.return_properties=["r"],self.incomingRelations(relation,cb)},Node.prototype.outgoingRelationsTo=function(node,relation,cb){var self=this.singletonForQuery();return self._query_history_.push({outgoingRelationshipsTo:!0}),self.cypher.segments.to=helpers.getIdFromObject(node)||node,"function"!=typeof relation&&(self.cypher.segments.relationship=relation),self.cypher.segments.return_properties=["r"],self.outgoingRelations(relation,cb)},Node.prototype.allDirections=function(relation,cb){var self=this.singletonForQuery();return self._query_history_.push({allDirections:!0}),"function"!=typeof relation&&(self.cypher.segments.relationship=relation),self.cypher.segments.node_identifier="n",self.cypher.segments.start.n="node("+self._start_node_id("*")+")",self.cypher.segments.start.m="node("+self._end_node_id("*")+")",self.cypher.segments.incoming=!0,self.cypher.segments.outgoing=!0,self.cypher.segments.return_properties=["n","m","r"],self.exec(cb),self},Node.prototype.relationsBetween=function(node,relation,cb){var self=this.singletonForQuery();return self._query_history_.push({relationshipsBetween:!0}),self.cypher.segments.to=helpers.getIdFromObject(node)||node,"function"!=typeof relation&&(self.cypher.segments.relationship=relation),self.cypher.segments.return_properties=["r"],self.exec(cb),self.allDirections(relation,cb)},Node.prototype.allRelations=function(relation,cb){var self=this.singletonForQuery(),label=this.cypher.segments.label?":"+this.cypher.segments.label:"";return"string"==typeof relation?relation=":"+relation:(cb=relation,relation=""),self._query_history_.push({allRelationships:!0}),self.cypher.segments.match=["(n"+label+")-[r"+relation+"]-()"],self.cypher.segments.return_properties=["r"],self.exec(cb),self},Node.prototype.limit=function(limit,cb){if(this._query_history_.push({LIMIT:limit}),this.cypher.segments.limit=parseInt(limit),0/0===limit)throw Error("LIMIT must be an integer number");if("DELETE"===this.cypher.segments.action)throw Error("You can't use a limit on a DELETE, use WHERE instead to specify your limit");return this.exec(cb),this},Node.prototype.skip=function(skip,cb){if(this.cypher.segments.skip=parseInt(skip),0/0===skip)throw Error("SKIP must be an integer number");return this._query_history_.push({SKIP:this.cypher.segments.skip}),this.exec(cb),this},Node.prototype.distinct=function(cb,value){return"boolean"!=typeof value&&(value=!0),this.cypher.segments._distinct=value,this._query_history_.push({dictinct:value}),this.exec(cb),this},Node.prototype.orderBy=function(property,cb,identifier){var direction="";if("object"==typeof property){var key=Object.keys(property)[0];cb=direction,direction=property[key],property=key,"string"==typeof direction&&/^(ASC|DESC)$/.test(direction)&&(this.cypher.segments.order_direction=direction)}else"string"==typeof property?this.cypher.segments.order_by=property:"string"==typeof cb&&(identifier=cb,cb=null);return"undefined"==typeof identifier&&(identifier=this.__TYPE_IDENTIFIER__),"string"==typeof identifier&&/^[nmr]$/i.test(identifier)?("n"===identifier&&this.whereNodeHasProperty(property),"m"===identifier&&this.whereEndNodeHasProperty(property),"r"===identifier&&this.whereRelationshipHasProperty(property)):identifier=null,this.cypher.segments.order_by=identifier?identifier+".`"+property+"`":property,this._query_history_.push({ORDER_BY:this.cypher.segments.order_by}),this.exec(cb),this},Node.prototype.orderNodeBy=function(property,direction,cb){return this.orderBy(property,direction,cb,"n")},Node.prototype.orderStartNodeBy=function(property,direction,cb){return this.orderNodeBy(property,direction,cb)},Node.prototype.orderEndNodeBy=function(property,direction,cb){return this.orderBy(property,direction,cb,"m")},Node.prototype.orderRelationshipBy=function(property,direction,cb){return this.orderBy(property,direction,cb,"r")},Node.prototype.match=function(string,cb){return/^n(\:[a-zA-Z]+)*$/.test(string)&&(string="("+string+")"),this._query_history_.push({MATCH:string}),this.cypher.segments.match.push(string),this.exec(cb),this},Node.prototype.return=function(returnStatement,cb,options){return"undefined"==typeof options&&(options={add:!1}),options.add||(this.cypher.segments.return_properties=[]),returnStatement&&(this.cypher.segments.return_properties=this.cypher.segments.return_properties.concat(returnStatement.constructor===Array?returnStatement:returnStatement.split(", ")),this._query_history_.push({RETURN:this.cypher.segments.return_properties})),this.exec(cb),this
},Node.prototype.start=function(start,cb){var self=this;return self._is_singleton_||(self=this.singleton(void 0,this)),self.label&&self.withLabel(self.label),self.cypher.segments.start="string"!=typeof start?null:start,self._query_history_.push({START:self.cypher.start}),self.exec(cb),self},Node.prototype.where=function(where,cb,options){if(_.isObject(where)){if(0===Object.keys(where).length)return this.exec(cb),this;_.isArray(where)||(where=[where])}"undefined"==typeof options&&(options={}),"string"!=typeof options.identifier&&(options.identifier="n"),-1===_.indexOf(this.cypher.segments.return_properties,options.identifier)&&this.cypher.segments.return_properties.push(options.identifier),this.cypher.segments.start&&(this.cypher.segments.start.n||(this.cypher.segments.start.n="node(*)"),this.cypher.segments.start.m&&(this.cypher.segments.start.m="node(*)"),"r"===options.identifier&&(this.cypher.segments.start.r="relationship(*)")),"undefined"==typeof options.valuesToParameters&&(options.valuesToParameters=Boolean(this.cypher.useParameters)),this.cypher.parameters&&this.cypher.parameters.length>0&&(options.parametersStartCountAt=this.cypher.parameters.length);var condition=new ConditionalParameters(_.extend(where),options),whereCondition=condition.toString();return this.cypher.segments.where.push(whereCondition),options.valuesToParameters&&condition.hasParameters()&&this._addParametersToCypher(condition.values()),this._query_history_.push({WHERE:whereCondition}),this.exec(cb),this},Node.prototype.whereStartNode=function(where,cb){return this.where(where,cb,{identifier:"n"})},Node.prototype.whereEndNode=function(where,cb){return this.where(where,cb,{identifier:"m"})},Node.prototype.whereNode=function(where,cb){return this.where(where,cb,{identifier:"n"})},Node.prototype.whereRelationship=function(where,cb){return this.where(where,cb,{identifier:"r"})},Node.prototype.whereRelation=function(where,cb){return this.whereRelationship(where,cb)},Node.prototype.whereHasProperty=function(property,identifier,cb){return this.andHasProperty(property,identifier,cb)},Node.prototype.andHasProperty=function(property,identifier,cb){return _.isFunction(identifier)&&(cb=identifier,identifier=null),"string"!=typeof property?cb(Error("Property name is mandatory."),null):(/^[nmr]\./.test(property)&&(property=property.replace(/^[nmr]\./,"")),/[\!\?]$/.test(property)||(0===this.cypher.segments.return_properties.length&&this.findAll(),"string"!=typeof identifier&&(identifier=this.cypher.segments.return_properties[this.cypher.segments.return_properties.length-1]),this.cypher.segments.hasProperty.push(identifier+".`"+property+"`"),this._query_history_.push({HAS:{identifier:identifier,property:property}})),this.exec(cb),this)},Node.prototype.whereNodeHasProperty=function(property,cb){return this.andHasProperty(property,"n",cb)},Node.prototype.whereStartNodeHasProperty=function(property,cb){return this.andHasProperty(property,"n",cb)},Node.prototype.whereEndNodeHasProperty=function(property,cb){return this.andHasProperty(property,"m",cb)},Node.prototype.whereRelationshipHasProperty=function(property,cb){return this.andHasProperty(property,"r",cb)},Node.prototype.delete=function(cb){if(this.hasId())return cb(Error("To delete a node, use remove(). delete() is for queries"),null);if(this.cypher.segments.limit)throw Error("You can't use a limit on a DELETE, use WHERE instead to specify your limit");return this._query_history_.push({DELETE:!0}),this.cypher.segments.action="DELETE",this.exec(cb)},Node.prototype.deleteIncludingRelations=function(cb){var label=this.label?":"+this.label:"";return Object.keys(this.cypher.segments.start).length<1&&(this.cypher.segments.start[this.__TYPE_IDENTIFIER__]=this.__TYPE__+"(*)"),this.cypher._optionalMatch=!0,this.cypher.segments.match=["("+this.__TYPE_IDENTIFIER__+label+")-[r]-()"],this.cypher.segments.return_properties=["n","r"],this.delete(cb)},Node.prototype.remove=function(cb){var self=this;return this.onBeforeRemove(function(){return self._is_singleton_?cb(Error("To delete results of a query use delete(). remove() is for removing an instanced "+this.__TYPE__),null):self.hasId()?Graph.start("n = node({id}) DELETE n",{id:self.id},cb):void 0}),this},Node.prototype.onBeforeRemove=function(next){next(null,null)},Node.prototype.removeIncludingRelations=function(cb){var self=this;return this.removeAllRelations(function(err){return err?cb(err,null):self.remove(cb)})},Node.prototype.removeOutgoingRelations=function(type,cb){return this.removeRelations(type,cb,{direction:"->"})},Node.prototype.removeIncomingRelations=function(type,cb){return this.removeRelations(type,cb,{direction:"<-"})},Node.prototype.removeAllRelations=function(cb){return this.removeRelations("",cb)},Node.prototype.removeRelations=function(type,cb,_options){"function"==typeof type&&(_options=cb,cb=type,type=null);var defaultOptions={direction:"all",type:type,endNodeId:null};if(_options="undefined"==typeof _options?_.extend({},defaultOptions):_.extend({},defaultOptions,_options),this.hasId()&&"function"==typeof cb){var direction=_options.direction;("incoming"!==direction||"outgoing"!==direction)&&(direction="all"),Node.prototype.findById(this.id)[direction+"Relations"]().delete(cb)}else cb(Error("You can remove relationships only from an instanced node /w a valid cb"),null);return this},Node.prototype.createRelation=function(options,cb){var self=this;if(options=_.extend({from_id:this._id_,to_id:null,type:null,properties:null,distinct:null},options),"string"!=typeof options.type)throw Error("You have to give the type of relationship, e.g. 'knows|follows'");if(options.properties&&(options.properties=helpers.flattenObject(options.properties)),_.isNumber(options.from_id)&&_.isNumber(options.to_id)&&"function"==typeof cb){if(!options.distinct)return Node.Relationship.create(options.type,options.properties,options.from_id,options.to_id,cb),self;Node.findById(options.from_id).outgoingRelationsTo(options.to_id,options.type,function(err,result){return err?cb(err,result):result&&1===result.length?(Node.Relationship.findById(result[0].id,function(err,relationship){relationship?(options.properties&&(relationship.data=options.properties),options.type&&(relationship.type=options.type),relationship.save(cb)):cb(err,relationship)}),void 0):(Node.Relationship.create(options.type,options.properties,options.from_id,options.to_id,cb),self)})}else cb(Error("Missing from_id("+options.from_id+") or to_id("+options.to_id+") OR no cb attached"),null);return this},Node.prototype.createRelationBetween=function(node,type,properties,cb,options){"object"!=typeof options&&(options={});var self=this;return"function"==typeof properties&&(cb=properties,properties={}),this.hasId()&&helpers.getIdFromObject(node)?self.createRelationTo(node,type,properties,function(err,resultFirst,debug_a){self.createRelationFrom(node,type,properties,function(secondErr,resultSecond,debug_b){err||secondErr?err&&secondErr?cb([err,secondErr],null,[debug_a,debug_b]):cb(err||secondErr,null,[debug_a,debug_b]):cb(null,[resultFirst,resultSecond],debug_a||debug_b)},options)},options):cb(Error("You need two instanced nodes as start and end point"),null),this},Node.prototype.createRelationTo=function(node,type,properties,cb,options){"object"!=typeof options&&(options={});var args,id=helpers.getIdFromObject(node);return(args=helpers.sortOptionsAndCallbackArguments(properties,cb))&&(properties=args.options)&&(cb=args.callback),options=_.extend({properties:properties,to_id:id,type:type},options),this.createRelation(options,cb)},Node.prototype.createRelationFrom=function(node,type,properties,cb,options){"object"!=typeof options&&(options={});var args,id=helpers.getIdFromObject(node);return(args=helpers.sortOptionsAndCallbackArguments(properties,cb))&&(properties=args.options)&&(cb=args.callback),options=_.extend({properties:properties,from_id:id,to_id:this.id,type:type},options),this.createRelation(options,cb)},Node.prototype.createOrUpdateRelation=function(options,cb){return"object"!=typeof options&&(options={}),options.distinct=!0,this.createRelation(options,cb)},Node.prototype.createOrUpdateRelationTo=function(node,type,properties,cb,options){return"object"!=typeof options&&(options={}),options.distinct=!0,this.createRelationTo(node,type,properties,cb,options)},Node.prototype.createOrUpdateRelationFrom=function(node,type,properties,cb,options){return"object"!=typeof options&&(options={}),options.distinct=!0,this.createRelationFrom(node,type,properties,cb,options)},Node.prototype.createOrUpdateRelationBetween=function(node,type,properties,cb,options){return"object"!=typeof options&&(options={}),options.distinct=!0,this.createRelationBetween(node,type,properties,cb,options)},Node.prototype.recommendConstructor=function(Fallback){"function"!=typeof Fallback&&(Fallback=this.constructor);var label=this.label?this.label:this.labels&&1===this.labels.length?this.labels[0]:null;return label?Node.registered_model(label)||Fallback:Fallback},Node.prototype.setId=function(id){return this.id=this._id_=id,this},Node.prototype.requestLabels=function(cb){return this.hasId()&&"function"==typeof cb&&Graph.request().get("node/"+this.id+"/labels",cb),this},Node.prototype.setLabel=function(label){return this.setLabels([label])},Node.prototype.setLabels=function(labels){return"string"==typeof labels&&(labels=[labels]),_.isArray(labels)&&(this.labels=labels),_.isArray(this.labels)&&1===this.labels.length&&(this.label=this.labels[0]),this},Node.prototype.labelsAsArray=function(){var labels=this.labels;return _.isArray(labels)||(labels=[]),this.label&&labels.push(this.label),labels=_.uniq(labels)},Node.prototype.allLabels=function(cb){return this.requestLabels(cb)},Node.prototype.createLabel=function(label,cb){return this.createLabels([label],cb)},Node.prototype.createLabels=function(labels,cb){return this.hasId()&&_.isFunction(cb)?Graph.request().post("node/"+this.id+"/labels",{data:labels},cb):void 0},Node.prototype.addLabels=function(labels,cb){var self=this;return this.hasId()&&_.isFunction(cb)?(_.isArray(labels)||(labels=[labels]),self.allLabels(function(err,storedLabels,debug){if(err)return cb(err,storedLabels,debug);_.isArray(storedLabels)||(storedLabels=[]);var addLabels=[];labels.forEach(function(label){-1===_.indexOf(storedLabels,label)&&addLabels.push(label)}),addLabels.length>0?self.createLabels(addLabels,cb):cb(null,storedLabels,debug)})):(this.labels=labels,1===labels.length&&(this.label=labels[0])),this},Node.prototype.addLabel=function(label,cb){return this.addLabels([label],cb)},Node.prototype.replaceLabels=function(labels,cb){var self=this;return this.hasId()&&_.isFunction(cb)&&(_.isArray(labels)||(labels=[labels]),self.labels=labels,Graph.request().put("node/"+self.id+"/labels",{data:labels},cb)),this},Node.prototype.removeLabels=function(cb){var id=this.id;return this.hasId()&&_.isFunction(cb)?(this.allLabels(function(err,labels,debug){if(err||!labels)return cb(err,labels,debug);var todo=labels.length;return 0===todo?cb(null,null,debug):(labels.forEach(function(label){return Graph.request().delete("node/"+id+"/labels/"+label,function(){todo--,0===todo&&cb(null,null,debug)})}),void 0)}),void 0):this},Node.prototype.toObject=function(){return{id:this.id,classification:this.classification,data:_.clone(this.data),uri:this.uri,label:this.label?this.label:null,labels:this.labels.length>0?_.clone(this.labels):[]}},Node.prototype.stream=function(cb){return this._stream_=!0,this.exec(cb)},Node.prototype.each=function(cb){return this.stream(cb)},Node.prototype.find=function(where,cb){var self=this;return self._is_singleton_||(self=this.singleton(void 0,this)),self._query_history_.push({find:!0}),self.label&&self.withLabel(self.label),"string"==typeof where||"object"==typeof where?self.where(where,cb):self.findAll(cb)},Node.prototype.findOne=function(where,cb){var self=this;return"function"==typeof where&&(cb=where,where=void 0),self=this.find(where),self.cypher.segments.limit=1,self.exec(cb)},Node.prototype.findById=function(id,cb){var self=this;self._is_singleton_||(self=this.singleton(void 0,this));var id=Number(id);if(isNaN(id))throw Error("You have to use a number as id argument");if(self._query_history_.push({findById:id}),"function"==typeof cb){var nodeSingleton=this.constructor.create().setId(id);return this.load||nodeSingleton.disableLoading(),nodeSingleton.exec(function(err,found,debug){return err&&"EntityNotFoundException"===err.exception?cb(null,null,debug):(found&&(found=found[0]),cb(err,found,debug),void 0)}),this}return self.cypher.segments.by_id=Number(id),self.findByKeyValue({id:id},cb)},Node.prototype.findByKeyValue=function(key,value,cb,_limit_){var self=this;if("undefined"==typeof _limit_&&(_limit_=null),self._is_singleton_||(self=this.singleton(void 0,this)),"object"==typeof key){cb=value;var _key=Object.keys(key)[0];value=key[_key],key=_key}if("string"!=typeof key&&(key="id"),_.isString(key)&&"undefined"!=typeof value){self._query_history_.push({findByKeyValue:!0});var identifier=self.cypher.segments.node_identifier||self.__TYPE_IDENTIFIER__;if(0===self.cypher.segments.return_properties.length&&(self.cypher.segments.return_properties=[identifier]),"id"!==key){var query={};query[key]=value,self.where(query),self.label&&self.withLabel(self.label)}if("function"==typeof cb)return self.exec(function(err,found){return err?cb(err,found):null===found?cb(null,found):(0===found.length?found=null:1===found.length&&1===_limit_?found=found[0]:_limit_>1&&found.length>_limit_&&(found=found.splice(0,_limit_)),cb(null,found))})}return self},Node.prototype.findOneByKeyValue=function(key,value,cb){return this.findByKeyValue(key,value,cb,1)},Node.prototype.findAll=function(cb){var self=this;return self._is_singleton_||(self=this.singleton(void 0,this)),self._query_history_.push({findAll:!0}),self.cypher.segments.limit=null,self.cypher.segments.return_properties=["n"],self.label&&self.withLabel(self.label),self.exec(cb)},Node.prototype.findOrCreate=function(where,cb){var self=this;return this.find(where).count(function(err,count,debug){if(err)return cb(err,count,debug);if(1===count)return self.findOne(where,cb);if(count>1)return cb(Error("More than one node found… You have query one distinct result"),null);var node=new self.constructor(where);node.save(cb)}),this},Node.prototype.singleton=function(id,label){var Class=this.constructor,node=new Class({},id);return"string"==typeof label&&(node.label=label),node.resetQuery(),node._is_singleton_=!0,node.resetQuery(),node},Node.singleton=function(id,label){return this.prototype.singleton(id,label)},Node.find=function(where,cb){return this.prototype.find(where,cb)},Node.findAll=function(cb){return this.prototype.findAll(cb)},Node.findById=function(id,cb){return this.prototype.findById(id,cb)},Node.findOne=function(where,cb){return this.prototype.findOne(where,cb)},Node.find=function(where,cb){return this.prototype.find(where,cb)},Node.findOrCreate=function(where,cb){return this.prototype.findOrCreate(where,cb)},Node.findByKeyValue=function(key,value,cb){return this.prototype.findByKeyValue(key,value,cb)},Node.findOneByKeyValue=function(key,value,cb){return this.prototype.findOneByKeyValue(key,value,cb)},Node.start=function(start,cb){return this.prototype.start(start,cb)},Node.query=function(cypherQuery,parameters,cb,options){return this.prototype.singleton().query(cypherQuery,parameters,cb,options)},Node.registerModel=function(Class,label,prototype,cb){var name=null,ParentModel=this;if("string"==typeof Class){if("function"==typeof label?(cb=label,prototype={}):"object"==typeof label?(cb=prototype,prototype=label,label=null):"function"==typeof prototype&&(cb=prototype,prototype={}),"object"!=typeof prototype&&(prototype={}),label=name=Class,Class=function(){this.init.apply(this,arguments)},_.extend(Class,ParentModel),prototype&&(_.extend(Class.prototype,ParentModel.prototype,prototype),prototype.fields)){var fieldDefinitions=prototype.fields;Class.prototype.fields={};for(var attribute in{indexes:{},defaults:{},unique:{}})ParentModel.prototype.fields&&ParentModel.prototype.fields[attribute]&&(Class.prototype.fields[attribute]=_.extend({},ParentModel.prototype.fields[attribute],fieldDefinitions[attribute]||{}))}Class.prototype._constructor_name_=Class.prototype.label=label,Class.prototype.labels=Class.prototype.labels?ParentModel.prototype.labels.slice():[],Class.prototype.labels.unshift(label)}else Class.prototype.labels=Class.getParentModels(),"string"==typeof label?name=label:(name=helpers.constructorNameOfFunction(Class),cb=label),Class.prototype.label=name;return Node.__models__[name]=Class,"function"==typeof cb&&Class.prototype.initialize(cb),Class},Node.getParentModels=function(){var models=[];if(models.push(helpers.constructorNameOfFunction(this)),this.__super__)for(var Class=this,i=0,modelName="";Class.__super__&&10>i;)i++,modelName=helpers.constructorNameOfFunction(Class.__super__),/^(Node|Relationship|Path)/.test(modelName)||models.push(modelName),Class.prototype.labels&&Class.prototype.labels.length>0&&models.push(Class.prototype.labels),Class=Class.__super__;return _.uniq(_.flatten(models))},Node.unregisterModel=function(Class){var name="string"==typeof Class?Class:helpers.constructorNameOfFunction(Class);return"function"==typeof Node.__models__[name]&&delete Node.__models__[name],Node.__models__},Node.registeredModels=function(){return Node.__models__},Node.registeredModel=function(model){return"function"==typeof model&&(model=helpers.constructorNameOfFunction(model)),Node.registeredModels()[model]||null},Node.ensureIndex=function(cb){return this.singleton().ensureIndex(cb)},Node.dropIndex=function(fields,cb){return this.singleton().dropIndex(fields,cb)},Node.dropEntireIndex=function(cb){return this.singleton().dropEntireIndex(cb)},Node.getIndex=function(cb){return this.singleton().getIndex(cb)},Node.disableLoading=function(){return this.prototype.disableLoading()},Node.enableLoading=function(){return this.prototype.enableLoading()},Node.deleteAllIncludingRelations=function(cb){return this.find().deleteIncludingRelations(cb)},Node.create=function(data,id,cb){"function"==typeof id&&(cb=id,id=void 0);var node=new this(data,id);return"function"==typeof cb?node.save(cb):node},Node.new=function(data,id,cb){return this.create(data,id,cb)},Node.setDefaultFields=function(fields){return this._setModelFields("defaults",fields)},Node.setIndexFields=function(fields){return this._setModelFields("indexes",fields)},Node.setUniqueFields=function(fields){return this._setModelFields("unique",fields)},Node._setModelFields=function(part,fields){for(var attribute in this.prototype.fields[part])delete this.prototype.fields[part][attribute];if("object"==typeof fields&&null!==fields)for(var attribute in fields)this.prototype.fields[part][attribute]=fields[attribute];return this},Node.registered_model=Node.registeredModel,Node.registered_models=Node.registeredModels,Node.unregister_model=Node.unregisterModel,Node.register_model=Node.registerModel,Node.prototype._addParametersToCypher=Graph.prototype._addParametersToCypher,Node.prototype._addParameterToCypher=Graph.prototype._addParameterToCypher,neo4jrestful.Node=Node};"object"!=typeof window?module.exports=exports={init:__initNode__}:window.Neo4jMapper.initNode=__initNode__;var __initPath__=function(neo4jrestful){var helpers=null,_=null;"object"==typeof window?(helpers=window.Neo4jMapper.helpers,_=window._):(helpers=require("./helpers"),_=require("underscore"));var Path=function(){this.nodes=[],this.relationships=[],this.from={id:null,uri:null},this.to={id:null,uri:null},this._is_instanced_=!0};return Path.prototype.classification="Path",Path.prototype.from=null,Path.prototype.to=null,Path.prototype.start=null,Path.prototype.end=null,Path.prototype.length=0,Path.prototype.relationships=null,Path.prototype.nodes=null,Path.prototype._response_=null,Path.prototype._is_singleton_=!1,Path.prototype._is_persisted_=!1,Path.prototype._is_instanced_=null,Path.prototype.singleton=function(){var path=new Path;return path._is_singleton_=!0,path},Path.prototype.populateWithDataFromResponse=function(data){var path=null!==this._is_instanced_?this:new Path;if(data){if(path._response_=_.isObject(data)&&!_.isArray(data)?data:data[0],_.isArray(data.nodes))for(var i=0;i<data.nodes.length;i++){var url=data.nodes[i];/[0-9]+$/.test(url)&&(data.nodes[i]={uri:url,id:Number(url.match(/[0-9]+$/)[0])})}if(path.nodes=_.extend(data.nodes),_.isArray(data.relationships))for(var i=0;i<data.relationships.length;i++){var url=data.relationships[i];/[0-9]+$/.test(url)&&(data.relationships[i]={uri:url,id:Number(url.match(/[0-9]+$/)[0])})}path.relationships=_.extend(data.relationships),path.from={id:Number(data.start.match(/[0-9]+$/)[0]),uri:data.start},path.to={id:Number(data.end.match(/[0-9]+$/)[0]),uri:data.end},path.start=data.start,path.end=data.end,path.length=data.length}return path._is_persisted_=!0,path},Path.prototype.load=function(cb){cb(null,this)},Path.prototype.toObject=function(){return{classification:this.classification,start:this.start,end:this.end,from:_.extend(this.from),to:_.extend(this.to),relationships:_.extend(this.relationships),nodes:_.extend(this.nodes)}},Path.prototype.resetQuery=function(){return this},Path.new=function(){return new Path},Path.create=Path.new,neo4jrestful.Path=Path};"object"!=typeof window?module.exports=exports={init:__initPath__}:window.Neo4jMapper.initPath=__initPath__;var __initRelationship__=function(neo4jrestful,Graph,Node){if("object"==typeof window)var helpers=window.Neo4jMapper.helpers,_=window._;else var helpers=require("./helpers"),_=require("underscore");var Relationship=function(type,data,start,end,id,cb){this.type=this._type_=type||null,this.from={id:null,uri:null},this.to={id:null,uri:null},this.data=data||{};var startID=null,endID=null;return start&&(Number(start.id)?startID=Number(start.id):Number(start)?startID=Number(start):start&&this.setPointIdByUri("from",start)),startID&&this.setPointUriById("from",startID),end&&(Number(end.id)?endID=Number(end.id):Number(end)?endID=Number(end):end&&this.setPointIdByUri("to",end)),endID&&this.setPointUriById("to",endID),this.fields=_.extend({},{defaults:_.extend({},this.fields.defaults),indexes:_.extend({},this.fields.indexes)}),this._is_instanced_=!0,"number"==typeof id?(this.setUriById(id),this.id=this._id_=id):cb=id,"function"==typeof cb?this.save(cb):void 0};return Relationship.prototype.classification="Relationship",Relationship.prototype.data={},Relationship.prototype.start=null,Relationship.prototype.type=null,Relationship.prototype._type_=null,Relationship.prototype.end=null,Relationship.prototype.from=null,Relationship.prototype.to=null,Relationship.prototype.id=null,Relationship.prototype._id_=null,Relationship.prototype._hashedData_=null,Relationship.prototype.uri=null,Relationship.prototype._response_=null,Relationship.prototype._is_singleton_=!1,Relationship.prototype._is_persisted_=!1,Relationship.prototype.cypher=null,Relationship.prototype._is_instanced_=null,Relationship.prototype.fields={defaults:{},indexes:{}},Relationship.prototype.__TYPE__="relationship",Relationship.prototype.__TYPE_IDENTIFIER__="r",Relationship.prototype.singleton=function(){var relationship=new Relationship;return relationship._is_singleton_=!0,relationship},Relationship.prototype.setPointUriById=function(startOrEnd,id){if("string"!=typeof startOrEnd&&(startOrEnd="from"),"from"!==startOrEnd&&"to"!==startOrEnd)throw Error("You have to set startOrEnd argument to 'from' or 'to'");return _.isNumber(id)&&(this[startOrEnd].uri=neo4jrestful.absoluteUrl("/relationship/"+id),this[startOrEnd].id=id),this},Relationship.prototype.setPointIdByUri=function(startOrEnd,uri){if("string"!=typeof startOrEnd&&(startOrEnd="from"),"from"!==startOrEnd&&"to"!==startOrEnd)throw Error("You have to set startOrEnd argument to 'from' or 'to'");uri.match(/[0-9]+$/)&&(this[startOrEnd].uri=uri,this[startOrEnd].id=Number(uri.match(/[0-9]+$/)[0]))},Relationship.prototype.applyDefaultValues=null,Relationship.prototype.findById=function(id,cb){var self=this;return self._is_singleton_||(self=this.singleton(void 0,this)),_.isNumber(Number(id))&&"function"==typeof cb?Graph.request().get(this.__TYPE__+"/"+id,function(err,object){object&&"function"==typeof self.load?object.load(cb):cb(err,object)}):this},Relationship.prototype.save=function(cb){var self=this;self.onBeforeSave(self,function(err){"undefined"!=typeof err&&null!==err?cb(err,null):self.onSave(function(err,relationship,debug){return err?cb(err,relationship,debug):self.onAfterSave(self,cb,debug)})})},Relationship.prototype.onSave=function(cb){var self=this;if(this._is_singleton_)return cb(Error("Singleton instances can not be persisted"),null);if(!this.hasValidData())return cb(Error("relationship does not contain valid data. `"+this.__TYPE__+".data` must be an object."));if(this.resetQuery(),this.applyDefaultValues(),this.id=this._id_,!this.type)throw Error("Type for a relationship is mandatory, e.g. `relationship.type = 'KNOW'`");if(!this.from||isNaN(this.from.id))throw Error("Relationship requires a `relationship.from` startnode");if(!this.to||isNaN(this.to.id))throw Error("Relationship requires a `relationship.to` endnode");if(this.hasId()){if(this._type_&&this.type!==this._type_)return Relationship.create(this.type,this.data,this.start,this.end,function(err,relationship,debug){return err?cb(err,relationship,debug):(self.remove(function(err,res,debugDelete){return err?cb(err,res,debugDelete):(relationship.copyTo(self),cb(null,self,debug))}),void 0)});Graph.start("r = relationship({id})",{id:Number(this.id)}).setWith({r:this.dataForCypher()}).return("r").exec(cb)}else Graph.start("n = node({from}), m = node({to})",{from:Number(this.from.id),to:Number(this.to.id)}).create(["(n)-[r: "+helpers.escapeProperty(this.type),this.dataForCypher(),"]->(m)"]).return("r").limit(1).exec(function(err,relationship,debug){return err||!relationship?cb(err,relationship,debug):(relationship.copyTo(self),cb(null,self,debug))})},Relationship.prototype.update=function(data,cb){return helpers.isObjectLiteral(data)?(this.data=_.extend(this.data,data),data=this.flattenData()):cb=data,this.save(cb)},Relationship.prototype.populateWithDataFromResponse=function(data,create){create="undefined"!=typeof create?create:!1;var relationship=null!==this._is_instanced_?this:new Relationship;return create&&(relationship=new Relationship),data&&(relationship._response_=_.isObject(data)&&!_.isArray(data)?data:data[0],relationship.data=relationship._response_.data,relationship.data=helpers.unflattenObject(this.data),relationship.uri=relationship._response_.self,relationship.type=relationship._type_=relationship._response_.type,relationship._response_.self&&relationship._response_.self.match(/[0-9]+$/)&&(relationship.id=relationship._id_=Number(relationship._response_.self.match(/[0-9]+$/)[0])),relationship._response_.start&&relationship._response_.start.match(/[0-9]+$/)&&(relationship.from.uri=relationship.start=relationship._response_.start,relationship.setPointIdByUri("from",relationship._response_.start)),relationship._response_.end&&relationship._response_.end.match(/[0-9]+$/)&&(relationship.to.uri=relationship.end=relationship._response_.end,relationship.setPointIdByUri("to",relationship._response_.end))),relationship._is_persisted_=!0,relationship.isPersisted(!0),relationship},Relationship.prototype.remove=function(cb){return this._is_singleton_?cb(Error("To delete results of a query use delete(). remove() is for removing a relationship."),null):this.hasId()?Graph.request().delete("relationship/"+this.id,cb):this},Relationship.prototype.loadFromAndToNodes=function(cb){for(var self=this,attributes=["from","to"],done=0,errors=[],i=0;2>i;i++)!function(point){Relationship.Node.findById(self[point].id,function(err,node){self[point]=node,err&&errors.push(err),done++,2===done&&cb(0===errors.length?null:errors,self)})}(attributes[i])},Relationship.prototype.load=function(cb){var self=this;this._onBeforeLoad(self,function(err,relationship){err?cb(err,relationship):self._onAfterLoad(relationship,cb)})},Relationship.prototype._onBeforeLoad=function(relationship,next){return this.onBeforeLoad(relationship,function(err,relationship){relationship.hasId()?relationship.loadFromAndToNodes(function(err,relationship){next(err,relationship)}):next(null,relationship)})},Relationship.prototype.onBeforeLoad=function(relationship,next){return next(null,relationship)},Relationship.prototype._onAfterLoad=function(relationship,next){return this.onAfterLoad(relationship,function(err,relationship){return next(null,relationship)})},Relationship.prototype.onAfterLoad=function(relationship,next){return next(null,relationship)},Relationship.prototype.toQuery=function(){return this.hasId()?Graph.start("r = relationship("+this.id+")").return("r").toQuery():Graph.start("r = relationship(*)").toQuery()},Relationship.prototype.toQueryString=Node.prototype.toQueryString,Relationship.prototype.toCypherQuery=Node.prototype.toCypherQuery,Relationship.prototype.toObject=function(){var o={id:this.id,classification:this.classification,data:_.clone(this.data),start:this.start,end:this.end,from:_.extend(this.from),to:_.extend(this.to),uri:this.uri,type:this.type};return o.from&&"function"==typeof o.from.toObject&&(o.from=o.from.toObject()),o.to&&"function"==typeof o.to.toObject&&(o.to=o.to.toObject()),o},Relationship.prototype._hashData_=function(){return this.hasValidData()?helpers.md5(JSON.stringify(this.toObject())):null},Relationship.prototype.onBeforeSave=function(node,next){next(null,null)},Relationship.prototype.onAfterSave=function(relationship,next,debug){return next(null,relationship,debug)},Relationship.prototype.resetQuery=function(){return this.cypher=new helpers.CypherQuery,this},Relationship.prototype._load_hook_reference_=null,Relationship.findById=function(id,cb){return this.prototype.findById(id,cb)},Relationship.recommendConstructor=function(){return Relationship},Relationship.prototype.applyDefaultValues=Node.prototype.applyDefaultValues,Relationship.prototype.copyTo=function(r){return r.id=r._id_=this._id_,r.data=_.clone(this.data),r.uri=this.uri,r._response_=_.clone(this._response_),r.from=_.clone(this.from),r.to=_.clone(this.to),r.start=this.start,r.end=this.end,r.type=r._type_=this._type_,r},Relationship.prototype.hasValidData=Node.prototype.hasValidData,Relationship.prototype.flattenData=Node.prototype.flattenData,Relationship.prototype.setUriById=Node.prototype.setUriById,Relationship.prototype.isPersisted=Node.prototype.isPersisted,Relationship.prototype.hasId=Node.prototype.hasId,Relationship.prototype.dataForCypher=Node.prototype.dataForCypher,Relationship.setDefaultFields=Node.setDefaultFields,Relationship.setIndexFields=Node.setIndexFields,Relationship.setUniqueFields=Node.setUniqueFields,Relationship._setModelFields=Node._setModelFields,Relationship.new=function(type,data,start,end,id,cb){return new Relationship(type,data,start,end,id,cb)},Relationship.create=Relationship.new,neo4jrestful.Relationship=Relationship};"object"!=typeof window?module.exports=exports={init:__initRelationship__}:window.Neo4jMapper.initRelationship=__initRelationship__;var __initTransaction__=function(neo4jrestful){var Statement=function(transaction,cypher,parameters){this._transaction_=transaction,this.statement=cypher,this.parameters=parameters};Statement.prototype._transaction_=null,Statement.prototype.statement="",Statement.prototype.parameters=null,Statement.prototype.status=null,Statement.prototype.position=null,Statement.prototype.results=null,Statement.prototype.errors=null,Statement.prototype.toObject=function(){return{statement:this.statement,parameters:JSON.stringify(this.parameters),status:this.status,position:this.position,errors:this.errors,results:this.results}};var Transaction=function(cypher,parameters,cb){this.neo4jrestful=neo4jrestful.singleton(),this.begin(cypher,parameters,cb)};return Transaction.Statement=Statement,Transaction.prototype.statements=null,Transaction.prototype._response_=null,Transaction.prototype.neo4jrestful=null,Transaction.prototype.status="",Transaction.prototype.id=null,Transaction.prototype.uri=null,Transaction.prototype.expires=null,Transaction.prototype.results=null,Transaction.prototype._concurrentTransmissions_=0,Transaction.prototype._responseError_=null,Transaction.prototype._resortResults_=!0,Transaction.prototype.begin=function(cypher,parameters,cb){return this.statements=[],this.results=[],this.errors=[],this.id=null,this.status="new",this.add(cypher,parameters,cb)
},Transaction.prototype.add=function(cypher,parameters,cb){var args=Transaction._sortTransactionArguments(cypher,parameters,cb),statements=args.statements;if("committed"===this.status){var err=Error("You can't add statements after transaction is committed");if("function"!=typeof args.cb)throw err;return cb(err,null),this}return this.addStatementsToQueue(statements),args.cb?(cb=args.cb,this.exec(cb)):this},Transaction.prototype.exec=function(cb){var self=this;if("function"!=typeof cb)return this;self.onResponse=cb;var url="",untransmittedStatements=this.untransmittedStatements();if("committing"===this.status)url=this.id?"/transaction/"+this.id+"/commit":"/transaction/commit";else if(this.id)if("open"===this.status)this.status="adding",url="/transaction/"+this.id;else{if(!(this.status="committed"))throw Error("Transaction has a unknown status. Possible are: creating|open|committing|committed");cb(Error("Transaction is committed. Create a new transaction instead."),null,null)}else this.status="creating",url="/transaction";var statements=[];return untransmittedStatements.forEach(function(statement,i){self.statements[i].status="sending",statements.push({statement:statement.statement,parameters:statement.parameters})}),this._concurrentTransmissions_++,this.neo4jrestful.post(url,{data:{statements:statements}},function(err,response,debug){if(self._response_=response,self._concurrentTransmissions_--,self._applyResponse(err,response,debug,untransmittedStatements),untransmittedStatements.forEach(function(statement){self.statements[statement.position].status=statement.status="sended"}),untransmittedStatements=self.untransmittedStatements(),untransmittedStatements.length>0)return self.exec(cb);if(0===self._concurrentTransmissions_&&"function"==typeof self.onResponse){var cb=self.onResponse;return self.onResponse=null,"committing"===self.status&&(self.status="committed"),cb(self._responseError_,self,debug),self}}),this},Transaction.prototype.addStatementsToQueue=function(statements){var self=this;return statements&&statements.constructor===Array&&statements.length>0&&statements.forEach(function(data){if(data.statement){var statement=new Statement(self,data.statement,data.parameters);statement.position=self.statements.length,self.statements.push(statement)}}),this},Transaction.prototype._applyResponse=function(err,response,debug,untransmittedStatements){var self=this;"committing"!==self.status&&(self.status="open"),err&&(self.status=err.status?err.status:err,self.status||(self.status=self._response_.status)),untransmittedStatements.forEach(function(statement,i){response.errors[i]&&(statement.error=response.errors[i],self.errors.push(response.errors[i])),response.results[i]&&(self._resortResults_&&response.results[i].data.forEach(function(data,j){data.row&&(response.results[i].data[j]=data.row)}),self.results.push(response.results[i]))}),err||!response?self._responseError_=self._responseError_?self._responseError_.push(err):self._responseError_=[err]:(self.populateWithDataFromResponse(response),"open"===self.status?Transaction.__open_transactions__[self.id]=self:delete Transaction.__open_transactions__[self.id])},Transaction.prototype.toObject=function(){var statements=[];return this.statements.forEach(function(stat){statements.push(stat.toObject())}),{id:this.id,status:this.status,statements:statements,expires:this.expires,uri:this.uri}},Transaction.prototype.populateWithDataFromResponse=function(data){if(data&&(data.transaction&&data.transaction.expires&&(this.expires=new Date(data.transaction.expires)),data.commit)){var match=data.commit.match(/^(.+?\/transaction\/(\d+))\/commit$/);this.id=Number(match[2]),this.uri=match[1]}},Transaction.prototype.untransmittedStatements=function(){var statements=[];return this.statements.forEach(function(statement){statement&&!statement.status&&statements.push(statement)}),statements},Transaction.prototype.commit=function(cypher,parameters,cb){if("function"==typeof cypher)cb=cypher;else{var args=Transaction._sortTransactionArguments(cypher,parameters,cb);this.addStatementsToQueue(args.statements),cb=args.cb}if("function"!=typeof cb)throw Error("You need to attach a callback an a commit/close operation");return this.onResponse=cb,this.status="committing",this.exec(cb)},Transaction.prototype.close=Transaction.prototype.commit,Transaction.create=function(cypher,parameters,cb){return new Transaction(cypher,parameters,cb)},Transaction.new=function(cypher,parameters){return new Transaction(cypher,parameters)},Transaction.prototype.onResponse=null,Transaction._sortTransactionArguments=function(cypher,parameters,cb){var statements=null;return"string"==typeof cypher?("function"==typeof parameters&&(cb=parameters,parameters={}),statements=[{statement:cypher,parameters:parameters||{}}]):cypher&&cypher.constructor===Array?(cb=parameters,statements=cypher):cypher&&cypher.statement&&(statements=[cypher]),{statements:statements,cb:cb||null}},Transaction.prototype.rollback=function(cb){var self=this;return this.id&&"finalized"!==this.status?this.neo4jrestful.delete("/transaction/"+this.id,function(err,res,debug){err||delete Transaction.__open_transactions__[self.id],cb(err,res,debug)}):cb(Error("You can only perform a rollback on an open transaction."),null),this},Transaction.prototype.undo=Transaction.prototype.rollback,Transaction.prototype.delete=Transaction.prototype.rollback,Transaction.begin=function(cypher,parameters,cb){return new Transaction(cypher,parameters,cb)},Transaction.create=Transaction.begin,Transaction.open=Transaction.begin,Transaction.commit=function(cypher,parameters,cb){return(new Transaction).commit(cypher,parameters,cb)},Transaction.executeAllOpenTransactions=function(cb,action){"undefined"==typeof action&&(action="commit");var count=Object.keys(Transaction.__open_transactions__).length,errors=[],debugs=[],_onDone_=function(err,res,debug){count--,err&&errors.push(err),debugs.push(debug),0===count&&cb(errors.length>0?errors:null,null,debugs)};for(var id in Transaction.__open_transactions__)Transaction.__open_transactions__[id][action](_onDone_);return this},Transaction.commitAll=function(cb){return this.executeAllOpenTransactions(cb,"commit")},Transaction.closeAll=Transaction.commitAll,Transaction.rollbackAll=function(cb){Transaction.executeAllOpenTransactions(cb,"rollback")},Transaction.deleteAll=Transaction.rollbackAll,Transaction.undoAll=Transaction.rollbackAll,Transaction.__open_transactions__={},neo4jrestful.Transaction=Transaction};"object"!=typeof window?module.exports=exports={init:__initTransaction__}:window.Neo4jMapper.initTransaction=__initTransaction__;var __initGraph__=function(neo4jrestful){if("object"==typeof window)var helpers=window.Neo4jMapper.helpers,_=window._,CypherQuery=window.Neo4jMapper.CypherQuery,ConditionalParameters=window.Neo4jMapper.ConditionalParameters;else var helpers=require("./helpers"),_=require("underscore"),CypherQuery=require("./cypherquery"),ConditionalParameters=require("./conditionalparameters");if("undefined"!=typeof neo4jrestful&&"Neo4jRestful"!==helpers.constructorNameOfFunction(neo4jrestful))throw Error("You have to use an Neo4jRestful object as argument");var Graph=function(url){return url&&(this.neo4jrestful=new neo4jrestful.constructor(url)),this.resetQuery(),this};return Graph.prototype.neo4jrestful=neo4jrestful,Graph.prototype._query_history_=null,Graph.prototype.cypher=null,Graph.prototype._queryString_="",Graph.prototype._loadOnResult_="node|relationship|path",Graph.prototype._resortResults_=!0,Graph.prototype._nativeResults_=!1,Graph.prototype.info=null,Graph.prototype._response_=null,Graph.prototype._columns_=null,Graph.prototype.exec=function(query,parameters,cb){return"function"==typeof query?(cb=query,query=void 0,parameters=void 0):"function"==typeof parameters&&(cb=parameters,"object"==typeof query&&(parameters=query,query=void 0)),"object"==typeof query&&(parameters=query,query=void 0),"object"==typeof parameters&&null!==parameters&&this.addParameters(parameters),"function"==typeof cb&&this.query(query,{},cb,{}),this},Graph.prototype.query=function(cypherQuery,parameters,cb,options){var self=this;return"string"!=typeof cypherQuery&&(cypherQuery=this.toCypherQuery()),"function"==typeof parameters&&(cb=parameters,options={},parameters={}),"object"!=typeof options&&null!==options&&(options={}),parameters||(parameters={}),Object.keys(parameters).length>0&&this.addParameters(parameters),options.params="boolean"==typeof this.cypher.useParameters?this.parameters():{},options.context=self,"function"==typeof cb?this.neo4jrestful.query(cypherQuery,options,function(err,res,debug){self._processResult(err,res,debug,options,function(err,res,debug){res&&1===res.length&&options.cypher&&(1===options.cypher.limit||options.cypher._update_||"object"!=typeof res[0])&&(res=res[0]),cb(err,res,debug)})}):this._queryString_=cypherQuery,this},Graph.prototype.__indexOfLabelColumn=function(columns){var labelColumns=this.__indexOfLabelColumns(columns),keys=Object.keys(labelColumns);return 1===keys.length?keys[0]:-1},Graph.prototype.__indexOfLabelColumns=function(columns){var labelColumns={};"undefined"==typeof columns&&(columns=this._columns_);for(var i=0;i<columns.length;i++)/^labels\([a-zA-Z]+\)$/.test(columns[i])&&(labelColumns[i]=columns[i]);return labelColumns},Graph.prototype.__removeLabelColumnFromArray=function(array,columnIndexOfLabel){return"number"!=typeof columnIndexOfLabel&&(columnIndexOfLabel=this.__indexOfLabelColumn()),array.splice(columnIndexOfLabel,1),array},Graph.prototype.__sortOutLabelColumn=function(result){var nodeLabels=[],nodeLabelsColumn=this.__indexOfLabelColumn(result.columns),self=this;if(nodeLabelsColumn>=0){for(var i=0;i<result.data.length;i++)nodeLabels.push(result.data[i][nodeLabelsColumn]),result.data[i]=self.__removeLabelColumnFromArray(result.data[i],nodeLabelsColumn);this._columns_=self.__removeLabelColumnFromArray(this._columns_,nodeLabelsColumn)}return nodeLabels},Graph.prototype._processResult=function(err,result,debug,options,cb){var self=options.context;if(self._response_=self.neo4jrestful._response_,self._columns_=self.neo4jrestful._columns_,err)return cb(err,result,debug);var loadNode=/node/i.test(self._loadOnResult_),loadRelationship=/relation/i.test(self._loadOnResult_),loadPath=/path/i.test(self._loadOnResult_),todo=0,iterationDone=!1;if(self._nativeResults_)return cb(err,result,debug);var __oneMoreJobDone=function(){if(0===todo&&iterationDone){if(0===result.data.length)return cb(err,null,debug);if(self._resortResults_){var cleanResult=result.data;if(1===self._columns_.length)for(var row=0;row<cleanResult.length;row++)cleanResult[row]=cleanResult[row][0];1===self.cypher.limit&&1===cleanResult.length&&(cleanResult=1===cleanResult.length?cleanResult[0]:null),cb(err,cleanResult,debug)}else cb(err,result,debug)}else todo--};if(!result.data&&1===result.length)return cb(err,result[0],debug);for(var nodeLabelsColumn=this.__indexOfLabelColumn(result.columns),nodeLabels=this._resortResults_?this.__sortOutLabelColumn(result):null,recommendConstructor=options.recommendConstructor,row=0;row<result.data.length;row++)for(var column=0;column<result.data[row].length;column++){var data=result.data[row][column];"object"==typeof data&&null!==data&&self.neo4jrestful.createObjectFromResponseData(result.data[row][column],recommendConstructor);var object=result.data[row][column];if(object){if("Node"===object.classification&&loadNode){if(nodeLabelsColumn>=0){var labels=nodeLabels.shift();object=self.neo4jrestful.Node.instantiateNodeAsModel(object,labels,options.recommendConstructor),object.__skip_loading_labels__=!0}todo++,object.load(__oneMoreJobDone)}else"Relationship"===object.classification&&loadRelationship?(todo++,object.load(__oneMoreJobDone)):"Path"===object.classification&&loadPath&&(todo++,object.load(__oneMoreJobDone));result.data[row][column]=object}}return iterationDone=!0,__oneMoreJobDone(),this},Graph.prototype.stream=function(cypherQuery,parameters,cb,options){var self=this,Node=Graph.Node;"function"==typeof cypherQuery?(cb=cypherQuery,cypherQuery=void 0):"function"==typeof parameters&&(cb=parameters,parameters=void 0),"string"!=typeof cypherQuery&&(cypherQuery=this.toCypherQuery()),parameters&&this.addParameters(parameters),options||(options={});var recommendConstructor=options?options.recommendConstructor||Node:Node;options.params="boolean"==typeof this.cypher.useParameters?this.parameters():{},parameters=this.parameters();var i=0,indexOfLabelColumn=null;return this.neo4jrestful.stream(cypherQuery,options,function(data,response,debug){if(self._columns_=response._columns_,self._resortResults_&&0===i&&(indexOfLabelColumn=self.__indexOfLabelColumn(self._columns_),indexOfLabelColumn>=0&&(self._columns_=self.__removeLabelColumnFromArray(self._columns_,indexOfLabelColumn))),data&&"object"==typeof data&&data.constructor===Array){var labels=null;self._resortResults_&&indexOfLabelColumn>=0&&(labels=data[indexOfLabelColumn],data=self.__removeLabelColumnFromArray(data,indexOfLabelColumn),1===data.length&&(data=data[0]));for(var column=0;column<data.length;column++)data[column]&&data[column]._response_&&(data[column]=self.neo4jrestful.createObjectFromResponseData(data[column]._response_,recommendConstructor),data[column]=self.neo4jrestful.Node.instantiateNodeAsModel(data[column],labels))}return self._response_=response,data&&data._response_&&(data=self.neo4jrestful.createObjectFromResponseData(data._response_,recommendConstructor)),i++,cb(data,self,debug)}),this},Graph.prototype.each=Graph.prototype.stream,Graph.prototype.setParameters=function(parameters){if("object"!=typeof parameters||null===parameters)throw Error('parameter(s) as argument must be an object, e.g. { key: "value" }');return null===this.cypher.useParameters&&(this.cypher.useParameters=!0),this.cypher.parameters=parameters,this},Graph.prototype.parameters=function(){return this.cypher.parameters||{}},Graph.prototype.addParameters=function(parameters){return this.cypher.addParameters(parameters),this},Graph.prototype.addParameter=function(parameter){return this.addParameters(parameter)},Graph.prototype.wipeDatabase=function(cb){var query="START n=node(*) MATCH n-[r?]-() DELETE n, r;";return this.query(query,cb)},Graph.prototype.countAllOfType=function(type,cb){var query="";return query=/^n(ode)*$/i.test(type)?"START n=node(*) RETURN count(n);":/^r(elationship)*$/i.test(type)?"START r=relationship(*) RETURN count(r);":/^[nr]\:.+/.test(type)?"MATCH "+type+" RETURN "+type[0]+";":"START n=node(*) OPTIONAL MATCH n-[r]-() RETURN count(n), count(r);",Graph.query(query,function(err,data){if(data&&data.data){var count=data.data[0][0];return"undefined"!=typeof data.data[0][1]&&(count+=data.data[0][1]),cb(err,count)}cb(err,data)})},Graph.prototype.countRelationships=function(cb){return this.countAllOfType("relationship",cb)},Graph.prototype.countRelations=function(cb){return this.countRelationships(cb)},Graph.prototype.countNodes=function(cb){return this.countAllOfType("node",cb)},Graph.prototype.countAll=function(cb){return this.countAllOfType("all",cb)},Graph.prototype.about=function(cb){var self=this;return this.info?cb(null,info):this.neo4jrestful.get("/"+this.neo4jrestful.urlOptions.endpoint,function(err,info){info&&(self.info=info),"function"==typeof cb&&cb(err,info)})},Graph.prototype.resetQuery=function(){return this._query_history_=[],this._queryString_="",this.cypher=new CypherQuery,this},Graph.prototype.start=function(start,parameters,cb){return this.resetQuery(),"function"==typeof start&&(cb=start,start=null),start&&this._query_history_.push({START:start}),this.exec(parameters,cb)},Graph.prototype.match=function(match,parameters,cb,options){var self=this;"object"!=typeof options&&(options={});var matchString="";return"object"==typeof match?match.length?match.forEach(function(item){matchString+="object"==typeof item?self._addObjectLiteralForStatement(item):String(item)}):matchString=self._addObjectLiteralForStatement(match):matchString=match,options.switch?"ON MATCH"===options.switch?this._query_history_.push({ON_MATCH:matchString}):"OPTIONAL MATCH"===options.switch&&this._query_history_.push({OPTIONAL_MATCH:matchString}):this._query_history_.push({MATCH:matchString}),this.exec(parameters,cb)},Graph.prototype.onMatch=function(onMatch,parameters,cb){return this.match(onMatch,parameters,cb,{"switch":"ON MATCH"})},Graph.prototype.optionalMatch=function(optionalMatch,parameters,cb){return this.match(optionalMatch,parameters,cb,{"switch":"OPTIONAL MATCH"})},Graph.prototype.with=function(withStatement,parameters,cb){return this._query_history_.push({WITH:withStatement}),this.exec(parameters,cb)},Graph.prototype.skip=function(skip,parameters,cb){if(skip=parseInt(skip),0/0===skip)throw Error("SKIP must be an integer");return this._query_history_.push({SKIP:skip}),this.exec(parameters,cb)},Graph.prototype.limit=function(limit,parameters,cb){if(limit=parseInt(limit),0/0===limit)throw Error("LIMIT must be an integer");return this._query_history_.push({LIMIT:limit}),this.cypher.limit=limit,this.exec(parameters,cb)},Graph.prototype.merge=function(merge,parameters,cb){return this._query_history_.push({MERGE:merge}),this.exec(parameters,cb)},Graph.prototype.custom=function(statement,parameters,cb){return"object"==typeof statement&&"function"==typeof statement.toQuery?this._query_history_.push(statement.toQuery().toString()):this._query_history_.push(statement),this.exec(parameters,cb)},Graph.prototype.set=function(set,parameters,cb){var setString="",data=null;if("object"==typeof set&&null!==set){if(set.constructor!==Array)if(data=set,set=[],this.cypher.useParameters)set=this._addKeyValuesToParameters(data," = ");else for(var key in data){var value=data[key];set.push(helpers.escapeProperty(key)+" = "+helpers.valueToStringForCypherQuery(value,"'"))}setString+=set.join(", ")}else setString+=set;return this._query_history_.push({SET:setString}),this.exec(parameters,cb)},Graph.prototype.setWith=function(setWith,parameters,cb){var setString="";return setString+=Object.keys(setWith)[0]+" = ",setString+=this.cypher.useParameters?this._addObjectLiteralToParameters(setWith[Object.keys(setWith)[0]]):helpers.serializeObjectForCypher(setWith[Object.keys(setWith)[0]]),this._query_history_.push({SET:setString}),this.exec(parameters,cb)},Graph.prototype.create=function(create,parameters,cb,options){var self=this,creates=[];if("object"!=typeof options&&(options={}),options=_.defaults(options,{action:"CREATE"}),"object"==typeof create){if(creates.push("( "),create.length)create.forEach(function(item){"object"==typeof item?creates.push(self._addObjectLiteralForStatement(item)):creates.push(String(item))});else{var parts=[];for(var part in create){for(var attr in create[part])(void 0===create[part][attr]||null===create[part][attr])&&delete create[part][attr];parts.push(part+" "+self._addObjectLiteralForStatement(create[part]))}creates.push(parts.join(", "))}creates.push(" )")}else creates=[create];var statementSegment={};return statementSegment[options.action]=creates.join(" "),this._query_history_.push(statementSegment),this.exec(parameters,cb)},Graph.prototype.onCreate=function(onCreate,parameters,cb){return this.create(onCreate,parameters,cb,{action:"ON_CREATE"})},Graph.prototype.createUnique=function(createUnique,parameters,cb){return this.create(createUnique,parameters,cb,{action:"CREATE_UNIQUE"})},Graph.prototype.createIndexOn=function(createIndexOn,parameters,cb){return this.create(createIndexOn,parameters,cb,{action:"CREATE_INDEX_ON"})},Graph.prototype.case=function(caseStatement,parameters,cb){return this._query_history_.push({CASE:caseStatement.replace(/END\s*$/i,"")+" END "}),this.exec(parameters,cb)},Graph.prototype.dropIndexOn=function(dropIndexOn,parameters,cb){return this._query_history_.push({DROP_INDEX_ON:dropIndexOn}),this.exec(parameters,cb)},Graph.prototype.orderBy=function(property,parameters,cb){var direction="",s="";if("object"==typeof property){var key=Object.keys(property)[0];cb=direction,direction=property[key],property=key,direction="string"==typeof direction&&/^(ASC|DESC)$/.test(direction)?direction:"ASC",s=property+" "+direction}else"string"==typeof property&&(s=property);return this._query_history_.push({ORDER_BY:s}),this.exec(parameters,cb)},Graph.prototype.where=function(where,parameters,cb){if("string"==typeof where)return this._query_history_.push({WHERE:where}),this.exec(parameters,cb);null===this.cypher.useParameters&&(this.cypher.useParameters=!0),_.isArray(where)||(where=[where]);var options={valuesToParameters:this.cypher.useParameters,parametersStartCountAt:Object.keys(this.cypher.parameters||{}).length},condition=new ConditionalParameters(where,options),whereCondition=condition.toString().replace(/^\(\s(.+)\)$/,"$1");return this._query_history_.push({WHERE:whereCondition}),this.cypher.useParameters&&this.addParameters(condition.parameters),this.exec(parameters,cb)},Graph.prototype.return=function(returnStatement,parameters,cb,distinct){var parts=[];return returnStatement&&(returnStatement.constructor===Array&&(parts=returnStatement),"Object"==typeof returnStatement&&Object.keys(returnStatement).length>0&&Object.keys(returnStatement).forEach(function(key){parts.push(key+" AS "+returnStatement[key])})),parts.length>0&&(returnStatement=parts.join(", ")),distinct===!0?this._query_history_.push({RETURN_DISTINCT:returnStatement}):this._query_history_.push({RETURN:returnStatement}),this.exec(parameters,cb)},Graph.prototype.returnDistinct=function(returnStatement,parameters,cb){return this.return(returnStatement,parameters,cb,!0)},Graph.prototype.delete=function(deleteStatement,parameters,cb){return this._query_history_.push({DELETE:deleteStatement}),this.exec(parameters,cb)},Graph.prototype.remove=function(remove,parameters,cb){return this._query_history_.push({REMOVE:remove}),this.exec(parameters,cb)},Graph.prototype.foreach=function(foreach,parameters,cb){return this._query_history_.push({FOREACH:foreach}),this.exec(parameters,cb)},Graph.prototype.union=function(union,parameters,cb){return this._query_history_.push({UNION:union}),this.exec(parameters,cb)},Graph.prototype.using=function(using,parameters,cb){return this._query_history_.push({USING:using}),this.exec(parameters,cb)},Graph.prototype.comment=function(comment,parameters,cb){return this.custom(" /* "+comment.replace(/^\s*\/\*\s*/,"").replace(/\s*\*\/\s*$/,"")+" */ "),this.exec(parameters,cb)},Graph.prototype.toQuery=function(){return this.cypher.statements=this._query_history_,this.cypher},Graph.prototype.toQueryString=function(){return this.toQuery().toString()},Graph.prototype.toCypherQuery=function(){return this.toQuery().toCypher()},Graph.prototype.enableLoading=function(classifications){return"*"===classifications&&(classifications="node|relationship|path"),this._loadOnResult_=classifications,this},Graph.prototype.disableLoading=function(){return this._loadOnResult_="",this},Graph.prototype.sortResult=function(trueOrFalse){return"undefined"==typeof trueOrFalse&&(trueOrFalse=!0),this._resortResults_=trueOrFalse,this},Graph.prototype.enableSorting=function(){return this.sortResult(!0)},Graph.prototype.disableSorting=function(){return this.sortResult(!1)},Graph.prototype.enableProcessing=function(){return this.sortResult(!0),this.enableLoading("*"),this},Graph.prototype.disableProcessing=function(){return this.sortResult(!1),this.disableLoading(),this},Graph.prototype.log=function(){},Graph.prototype._addParametersToCypher=function(parameters){if("object"!=typeof parameters||!parameters||parameters.constructor!==Array)throw Error("You need to pass parameters as array");this.cypher.hasParameters()||(this.cypher.parameters={});for(var i=0;i<parameters.length;i++)this._addParameterToCypher(parameters[i]);return this.cypher.parameters},Graph.prototype._addParameterToCypher=function(parameter){if(this.cypher.hasParameters()||(this.cypher.parameters={}),"object"!=typeof parameter||null===parameter){var count=Object.keys(this.cypher.parameters).length;return this.cypher.parameters["_value"+count+"_"]="undefined"==typeof parameter?null:parameter,"{_value"+count+"_}"}return _.extend(this.cypher.parameters,parameter),this.cypher.parameters},Graph.prototype._addKeyValuesToParameters=function(o,assignOperator){o=helpers.flattenObject(o);var values=[],identifierDelimiter="`";"string"!=typeof assignOperator&&(assignOperator=" = ");for(var attr in o)values.push(helpers.escapeProperty(attr,identifierDelimiter)+assignOperator+this._addParameterToCypher(o[attr]));return values},Graph.prototype._addObjectLiteralToParameters=function(objectLiteral){return"{ "+this._addKeyValuesToParameters(objectLiteral," : ").join(", ")+" }"},Graph.prototype._addObjectLiteralForStatement=function(o){var s="";return s=this.cypher.useParameters?this._addObjectLiteralToParameters(o):helpers.serializeObjectForCypher(o)},Graph.query=function(cypher,parameters,cb,options){return Graph.disableProcessing().query(cypher,parameters,cb,options)},Graph.stream=function(cypher,parameters,cb,options){return(new Graph.disableProcessing).stream(cypher,parameters,cb,options)},Graph.wipeDatabase=function(cb){return(new Graph).wipeDatabase(cb)},Graph.countAllOfType=function(type,cb){return(new Graph).countAllOfType(type,cb)},Graph.countRelationships=function(cb){return(new Graph).countRelationships(cb)},Graph.countRelations=function(cb){return(new Graph).countRelationships(cb)},Graph.countNodes=function(cb){return(new Graph).countNodes(cb)},Graph.countAll=function(cb){return(new Graph).countAll(cb)},Graph.about=function(cb){return(new Graph).about(cb)},Graph.start=function(start,parameters,cb){return(new Graph).enableProcessing().start(start,parameters,cb)},Graph.custom=function(statement,parameters,cb){return Graph.start().custom(statement,parameters,cb)},Graph.match=function(statement,parameters,cb){return Graph.start().match(statement,parameters,cb)},Graph.where=function(statement,parameters,cb){return Graph.start().where(statement,parameters,cb)},Graph.return=function(statement,parameters,cb){return Graph.start().return(statement,parameters,cb)},Graph.create=function(statement,parameters,cb){return Graph.start().create(statement,parameters,cb)},Graph.enableLoading=function(classifications){return Graph.start().enableLoading(classifications)},Graph.disableLoading=function(){return Graph.start().disableLoading()},Graph.disableProcessing=function(){return Graph.start().disableProcessing()},Graph.enableProcessing=function(){return Graph.start().enableProcessing()},Graph.enableSorting=function(){return Graph.start().enableSorting()},Graph.disableSorting=function(){return Graph.start().disableSorting()},Graph.request=function(){return neo4jrestful.singleton()},Graph.new=function(url){return new Graph(url)},neo4jrestful.Graph=Graph};"object"!=typeof window?module.exports=exports={init:__initGraph__}:window.Neo4jMapper.initGraph=__initGraph__}();